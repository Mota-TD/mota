<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mota.project.mapper.ProjectMemberMapper">

    <!-- 项目成员结果映射 -->
    <resultMap id="ProjectMemberResultMap" type="com.mota.project.entity.ProjectMember">
        <id column="id" property="id"/>
        <result column="project_id" property="projectId"/>
        <result column="user_id" property="userId"/>
        <result column="role" property="role"/>
        <result column="department_id" property="departmentId"/>
        <result column="joined_at" property="joinedAt"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="created_by" property="createdBy"/>
        <result column="updated_by" property="updatedBy"/>
        <result column="deleted" property="deleted"/>
        <result column="version" property="version"/>
    </resultMap>

    <!-- 根据项目ID查询成员列表 -->
    <select id="selectByProjectId" resultMap="ProjectMemberResultMap">
        SELECT pm.*
        FROM project_member pm
        WHERE pm.project_id = #{projectId}
          AND pm.deleted = 0
        ORDER BY pm.joined_at ASC
    </select>

    <!-- 根据用户ID查询参与的项目成员记录 -->
    <select id="selectByUserId" resultMap="ProjectMemberResultMap">
        SELECT pm.*
        FROM project_member pm
        WHERE pm.user_id = #{userId}
          AND pm.deleted = 0
        ORDER BY pm.joined_at DESC
    </select>

    <!-- 根据项目ID和用户ID查询成员 -->
    <select id="selectByProjectIdAndUserId" resultMap="ProjectMemberResultMap">
        SELECT pm.*
        FROM project_member pm
        WHERE pm.project_id = #{projectId}
          AND pm.user_id = #{userId}
          AND pm.deleted = 0
        LIMIT 1
    </select>

    <!-- 根据项目ID和角色查询成员列表 -->
    <select id="selectByProjectIdAndRole" resultMap="ProjectMemberResultMap">
        SELECT pm.*
        FROM project_member pm
        WHERE pm.project_id = #{projectId}
          AND pm.role = #{role}
          AND pm.deleted = 0
        ORDER BY pm.joined_at ASC
    </select>

    <!-- 根据项目ID和部门ID查询成员列表 -->
    <select id="selectByProjectIdAndDepartmentId" resultMap="ProjectMemberResultMap">
        SELECT pm.*
        FROM project_member pm
        WHERE pm.project_id = #{projectId}
          AND pm.department_id = #{departmentId}
          AND pm.deleted = 0
        ORDER BY pm.joined_at ASC
    </select>

    <!-- 统计项目成员数量 -->
    <select id="countByProjectId" resultType="int">
        SELECT COUNT(*)
        FROM project_member pm
        WHERE pm.project_id = #{projectId}
          AND pm.deleted = 0
    </select>

</mapper>