<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mota.project.mapper.ai.AIKnowledgeDocumentMapper">

    <resultMap id="BaseResultMap" type="com.mota.project.entity.ai.AIKnowledgeDocument">
        <id column="id" property="id"/>
        <result column="title" property="title"/>
        <result column="original_filename" property="originalFilename"/>
        <result column="file_path" property="filePath"/>
        <result column="file_type" property="fileType"/>
        <result column="file_size" property="fileSize"/>
        <result column="mime_type" property="mimeType"/>
        <result column="content_text" property="contentText"/>
        <result column="content_html" property="contentHtml"/>
        <result column="parse_status" property="parseStatus"/>
        <result column="parse_error" property="parseError"/>
        <result column="parsed_at" property="parsedAt"/>
        <result column="page_count" property="pageCount"/>
        <result column="word_count" property="wordCount"/>
        <result column="char_count" property="charCount"/>
        <result column="language" property="language"/>
        <result column="category_id" property="categoryId"/>
        <result column="folder_id" property="folderId"/>
        <result column="team_id" property="teamId"/>
        <result column="creator_id" property="creatorId"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="deleted_at" property="deletedAt"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, title, original_filename, file_path, file_type, file_size, mime_type,
        content_text, content_html, parse_status, parse_error, parsed_at,
        page_count, word_count, char_count, language, category_id, folder_id,
        team_id, creator_id, created_at, updated_at, deleted_at
    </sql>

    <!-- 分页查询文档列表 -->
    <select id="selectDocumentPage" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM ai_knowledge_document
        WHERE deleted_at IS NULL
        <if test="teamId != null">
            AND team_id = #{teamId}
        </if>
        <if test="categoryId != null">
            AND category_id = #{categoryId}
        </if>
        <if test="fileType != null and fileType != ''">
            AND file_type = #{fileType}
        </if>
        <if test="parseStatus != null and parseStatus != ''">
            AND parse_status = #{parseStatus}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (title LIKE CONCAT('%', #{keyword}, '%')
                 OR original_filename LIKE CONCAT('%', #{keyword}, '%')
                 OR content_text LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY created_at DESC
    </select>

    <!-- 根据团队ID统计文档数量 -->
    <select id="countByTeamId" resultType="int">
        SELECT COUNT(*)
        FROM ai_knowledge_document
        WHERE deleted_at IS NULL
        <if test="teamId != null">
            AND team_id = #{teamId}
        </if>
    </select>

    <!-- 获取待解析的文档列表 -->
    <select id="selectPendingDocuments" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM ai_knowledge_document
        WHERE deleted_at IS NULL
          AND parse_status = 'pending'
        ORDER BY created_at ASC
        LIMIT #{limit}
    </select>

    <!-- 全文搜索文档 -->
    <select id="fullTextSearch" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM ai_knowledge_document
        WHERE deleted_at IS NULL
          AND parse_status = 'completed'
        <if test="teamId != null">
            AND team_id = #{teamId}
        </if>
        <if test="keyword != null and keyword != ''">
            AND MATCH(content_text) AGAINST(#{keyword} IN NATURAL LANGUAGE MODE)
        </if>
        ORDER BY created_at DESC
        LIMIT #{limit}
    </select>

    <!-- 批量更新解析状态 -->
    <update id="batchUpdateParseStatus">
        UPDATE ai_knowledge_document
        SET parse_status = #{status},
            updated_at = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

</mapper>