server:
  port: 8080
  servlet:
    encoding:
      charset: UTF-8
      enabled: true
      force: true
  # Netty 配置
  netty:
    connection-timeout: 60000

spring:
  application:
    name: mota-gateway
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}
  config:
    import: optional:nacos:${spring.application.name}.yml
  cloud:
    nacos:
      discovery:
        server-addr: ${NACOS_SERVER:localhost:8848}
        namespace: ${NACOS_NAMESPACE:}
        group: ${NACOS_GROUP:DEFAULT_GROUP}
        # Docker 环境下使用容器 IP
        ip: ${NACOS_DISCOVERY_IP:}
        port: ${NACOS_DISCOVERY_PORT:8080}
      config:
        server-addr: ${NACOS_SERVER:localhost:8848}
        namespace: ${NACOS_NAMESPACE:}
        group: ${NACOS_GROUP:DEFAULT_GROUP}
        file-extension: yml
        refresh-enabled: true
    httpclient:
      connect-timeout: 60000
      response-timeout: 60000
      pool:
        max-connections: 500
        max-idle-time: 60000
    gateway:
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true
      routes:
        # ==================== 认证服务 ====================
        - id: mota-auth-service
          uri: lb://mota-auth-service
          predicates:
            - Path=/api/v1/auth/**
          filters:
            - StripPrefix=0

        # ==================== 用户服务 ====================
        # 用户管理功能已集成到项目服务中
        - id: mota-user-service
          uri: lb://mota-project-service
          predicates:
            - Path=/api/v1/users/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # 角色管理 - 路由到用户服务
        - id: mota-role-service
          uri: lb://mota-user-service
          predicates:
            - Path=/api/v1/roles/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # ==================== 项目服务 ====================
        - id: mota-project-service
          uri: lb://mota-project-service
          predicates:
            - Path=/api/v1/projects/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # 任务服务（项目服务）
        - id: mota-task-service
          uri: lb://mota-project-service
          predicates:
            - Path=/api/v1/tasks/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # 里程碑服务（项目服务）
        - id: mota-milestone-service
          uri: lb://mota-project-service
          predicates:
            - Path=/api/v1/milestones/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # 里程碑任务服务（独立任务服务）
        - id: mota-milestone-task-service
          uri: lb://mota-task-service
          predicates:
            - Path=/api/v1/milestone-tasks/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # 部门服务（项目服务）
        - id: mota-department-service
          uri: lb://mota-project-service
          predicates:
            - Path=/api/v1/departments/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # 部门任务服务（项目服务）
        - id: mota-department-task-service
          uri: lb://mota-project-service
          predicates:
            - Path=/api/v1/department-tasks/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # 活动服务（项目服务）
        - id: mota-activity-service
          uri: lb://mota-project-service
          predicates:
            - Path=/api/v1/activities/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # 仪表盘服务（项目服务）
        - id: mota-dashboard-service
          uri: lb://mota-project-service
          predicates:
            - Path=/api/v1/dashboard/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # 效能指标服务（项目服务）
        - id: mota-metrics-service
          uri: lb://mota-project-service
          predicates:
            - Path=/api/v1/metrics/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # 视图配置服务（项目服务）
        - id: mota-view-config-service
          uri: lb://mota-project-service
          predicates:
            - Path=/api/v1/view-configs/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # 工作流服务（项目服务）
        - id: mota-workflow-service
          uri: lb://mota-project-service
          predicates:
            - Path=/api/v1/workflows/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # 进度报告服务（项目服务）
        - id: mota-progress-service
          uri: lb://mota-project-service
          predicates:
            - Path=/api/v1/progress/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # 资源管理服务（项目服务）
        - id: mota-resource-service
          uri: lb://mota-project-service
          predicates:
            - Path=/api/v1/resources/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # ==================== AI服务（独立微服务） ====================
        # 注意：更具体的路由必须放在通用路由之前，Spring Cloud Gateway按顺序匹配
        # AI核心功能统一路由到 mota-ai-service
        
        # AI助手/对话服务 - 路由到独立AI服务
        - id: mota-ai-assistant-service
          uri: lb://mota-ai-service
          predicates:
            - Path=/api/v1/ai/assistant/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # AI新闻服务 - 路由到独立AI服务
        - id: mota-ai-news-service
          uri: lb://mota-ai-service
          predicates:
            - Path=/api/v1/ai/news/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # AI方案生成服务 - 路由到独立AI服务
        - id: mota-ai-proposal-service
          uri: lb://mota-ai-service
          predicates:
            - Path=/api/v1/ai/proposal/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # AI训练服务 - 路由到独立AI服务
        - id: mota-ai-training-service
          uri: lb://mota-ai-service
          predicates:
            - Path=/api/v1/ai/training/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # AI智能搜索服务 - 路由到独立AI服务
        - id: mota-ai-search-service
          uri: lb://mota-ai-service
          predicates:
            - Path=/api/v1/ai/search/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # AI多模型管理服务 - 路由到独立AI服务
        - id: mota-ai-multi-model-service
          uri: lb://mota-ai-service
          predicates:
            - Path=/api/v1/ai/multi-model/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # AI项目协同功能 - 路由到项目服务（项目相关的AI功能）
        - id: mota-ai-project-service
          uri: lb://mota-project-service
          predicates:
            - Path=/api/v1/ai/project/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # AI历史记录 - 路由到项目服务
        - id: mota-ai-history-service
          uri: lb://mota-project-service
          predicates:
            - Path=/api/v1/ai/history/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # AI方案/解决方案生成 - 路由到项目服务（项目方案）
        - id: mota-ai-solution-service
          uri: lb://mota-project-service
          predicates:
            - Path=/api/v1/ai/solution/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # AI PPT生成 - 路由到项目服务
        - id: mota-ai-ppt-service
          uri: lb://mota-project-service
          predicates:
            - Path=/api/v1/ai/ppt/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # AI知识库服务 - 路由到项目服务（项目知识库）
        - id: mota-ai-knowledge-service
          uri: lb://mota-project-service
          predicates:
            - Path=/api/v1/ai/knowledge/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # AI服务 - 其他通用AI功能 - 路由到AI服务（最后匹配）
        - id: mota-ai-general-service
          uri: lb://mota-ai-service
          predicates:
            - Path=/api/v1/ai/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # 智能搜索服务 - 路由到AI服务
        - id: mota-search-service
          uri: lb://mota-ai-service
          predicates:
            - Path=/api/v1/search/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # ==================== 知识服务（独立微服务） ====================
        # 注意：知识相关功能目前分布在两个服务中
        # - mota-knowledge-service: 文件管理、模板管理
        # - mota-project-service: 知识图谱、知识统计（待迁移）
        
        # 知识图谱 - 暂时路由到项目服务（使用 /api/v1/knowledge-graph 路径）
        - id: mota-knowledge-graph
          uri: lb://mota-project-service
          predicates:
            - Path=/api/v1/knowledge-graph/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # 知识统计 - 暂时路由到项目服务（使用 /api/v1/knowledge/statistics 路径）
        # 注意：这个路由必须在通用知识路由之前
        - id: mota-knowledge-statistics
          uri: lb://mota-project-service
          predicates:
            - Path=/api/v1/knowledge/statistics/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # 知识文件 - 路由到知识服务
        - id: mota-knowledge-files-service
          uri: lb://mota-knowledge-service
          predicates:
            - Path=/api/v1/knowledge/files/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # 知识模板 - 路由到知识服务
        - id: mota-template-service
          uri: lb://mota-knowledge-service
          predicates:
            - Path=/api/v1/knowledge/templates/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # 知识服务通用路由 - 路由到知识服务（最后匹配）
        - id: mota-knowledge-service
          uri: lb://mota-knowledge-service
          predicates:
            - Path=/api/v1/knowledge/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # 文档管理
        - id: mota-document-service
          uri: lb://mota-knowledge-service
          predicates:
            - Path=/api/v1/documents/**
          filters:
            - StripPrefix=0
            - AuthFilter


        # ==================== 通知服务 ====================
        # 通知功能 - 路由到项目服务（项目服务提供完整的通知功能，包括聚合、智能分类、置顶等）
        - id: mota-notifications-service
          uri: lb://mota-project-service
          predicates:
            - Path=/api/v1/notifications/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # 内部通知服务 - 路由到独立通知服务（用于服务间调用）
        - id: mota-notify-internal-service
          uri: lb://mota-notify-service
          predicates:
            - Path=/api/v1/notify/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # ==================== 日历功能 ====================
        # 日历事件 - 路由到项目服务（因为需要访问任务和里程碑数据）
        - id: mota-calendar-events
          uri: lb://mota-project-service
          predicates:
            - Path=/api/v1/calendar-events/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # 日历配置 - 路由到项目服务
        - id: mota-calendar-configs
          uri: lb://mota-project-service
          predicates:
            - Path=/api/v1/calendar-configs/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # 日历订阅 - 路由到项目服务
        - id: mota-calendar-subscriptions
          uri: lb://mota-project-service
          predicates:
            - Path=/api/v1/calendar-subscriptions/**
          filters:
            - StripPrefix=0
            - AuthFilter

        # ==================== 新闻服务（项目服务） ====================
        # 智能新闻推送 - 路由到项目服务（统一使用/api/v1/前缀）
        - id: mota-news-service
          uri: lb://mota-project-service
          predicates:
            - Path=/api/v1/news/**
          filters:
            - StripPrefix=0
            - AuthFilter

      # 全局跨域配置
      globalcors:
        cors-configurations:
          '[/**]':
            allowed-origin-patterns:
              - "*"
            allowed-methods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
              - PATCH
            allowed-headers: "*"
            allow-credentials: true
            max-age: 3600

  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: 0
      timeout: 10000
      lettuce:
        pool:
          max-active: 20
          max-idle: 10
          min-idle: 5
          max-wait: -1

# JWT配置
jwt:
  secret: ${JWT_SECRET:bW90YS1zZWNyZXQta2V5LWZvci1qd3QtdG9rZW4tZ2VuZXJhdGlvbi1tdXN0LWJlLWF0LWxlYXN0LTI1Ni1iaXRz}
  expiration: 86400000
  refresh-expiration: 604800000
  issuer: mota
  # 白名单路径（不需要认证）
  white-list:
    - /api/v1/auth/login
    - /api/v1/auth/register
    - /api/v1/auth/refresh
    - /api/v1/auth/captcha
    - /api/v1/auth/validate-invitation
    - /api/v1/auth/forgot-password
    - /api/v1/auth/reset-password
    - /api/v1/auth/industries
    - /api/v1/auth/industries/**
    - /api/v1/public/**
    - /actuator/**
    - /doc.html
    - /webjars/**
    - /swagger-resources/**
    - /v3/api-docs/**
    - /favicon.ico

# 网关配置
gateway:
  # IP过滤配置
  ip-filter:
    enabled: ${IP_FILTER_ENABLED:false}
    whitelist-mode: false
    # IP白名单（仅在whitelist-mode为true时生效）
    whitelist:
      - 127.0.0.1
      - ::1
    # IP黑名单
    blacklist: []
    # 动态黑名单（Redis存储）
    dynamic-blacklist-enabled: true
    dynamic-blacklist-ttl: 3600
  
  # 请求体大小限制配置
  request-size:
    enabled: true
    # 默认最大请求体大小：10MB
    max-request-size: 10485760
    # 文件上传最大大小：100MB
    max-file-upload-size: 104857600
    # 文件上传路径
    file-upload-paths:
      - /api/v1/knowledge/files/**
      - /api/v1/documents/upload/**
      - /api/v1/tasks/*/attachments/**
      - /api/v1/projects/*/files/**
    # 路径级别的大小限制
    path-limits:
      /api/v1/ai/training/documents: 209715200  # 200MB
      /api/v1/knowledge/import: 524288000       # 500MB

# 限流配置
rate-limiter:
  enabled: ${RATE_LIMITER_ENABLED:true}
  # 每秒请求数
  replenish-rate: ${RATE_LIMITER_REPLENISH_RATE:100}
  # 令牌桶容量
  burst-capacity: ${RATE_LIMITER_BURST_CAPACITY:200}

# 熔断配置
resilience4j:
  circuitbreaker:
    configs:
      default:
        sliding-window-size: 10
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10000
        permitted-number-of-calls-in-half-open-state: 3
        slow-call-duration-threshold: 2000
        slow-call-rate-threshold: 80
    instances:
      backendService:
        base-config: default
  timelimiter:
    configs:
      default:
        timeout-duration: 30s

# 日志配置
logging:
  level:
    root: ${LOG_LEVEL:INFO}
    com.mota: ${MOTA_LOG_LEVEL:DEBUG}
    org.springframework.cloud.gateway: ${GATEWAY_LOG_LEVEL:INFO}
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: ${LOG_PATH:/app/logs}/gateway.log
    max-size: 100MB
    max-history: 30

# Actuator配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway,prometheus,metrics
      base-path: /actuator
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
    gateway:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}
  health:
    livenessState:
      enabled: true
    readinessState:
      enabled: true