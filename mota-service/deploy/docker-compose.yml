# =====================================================
# Mota 主 Docker Compose 配置
# 整合所有服务的入口文件
# =====================================================
#
# 使用方式:
# 1. 仅启动中间件: docker-compose -f docker-compose.middleware.yml up -d
# 2. 启动微服务: docker-compose -f docker-compose.services.yml up -d
# 3. 启动监控: docker-compose -f docker-compose.monitor.yml up -d
# 4. 启动全部: docker-compose up -d
#
# =====================================================

include:
  - docker-compose.middleware.yml
  - docker-compose.services.yml

services:
  # =====================================================
  # Nginx 反向代理
  # =====================================================
  nginx:
    image: nginx:1.25-alpine
    container_name: mota-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - /var/www/certbot:/var/www/certbot:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /var/www/mota:/var/www/mota:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - gateway
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - mota-network

  # =====================================================
  # Certbot SSL 证书自动续期
  # =====================================================
  certbot:
    image: certbot/certbot:latest
    container_name: mota-certbot
    volumes:
      - /var/www/certbot:/var/www/certbot
      - /etc/letsencrypt:/etc/letsencrypt
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - mota-network
    profiles:
      - ssl

# =====================================================
# 数据卷配置
# =====================================================
volumes:
  nginx_logs:
    driver: local