# =====================================================
# Prometheus 告警规则
# =====================================================

groups:
  # =====================================================
  # 基础设施告警
  # =====================================================
  - name: infrastructure
    rules:
      # 服务器宕机
      - alert: InstanceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "实例 {{ $labels.instance }} 宕机"
          description: "{{ $labels.instance }} 已经宕机超过 1 分钟"

      # CPU 使用率过高
      - alert: HighCpuUsage
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "实例 {{ $labels.instance }} CPU 使用率过高"
          description: "CPU 使用率超过 80%，当前值: {{ $value }}%"

      # 内存使用率过高
      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "实例 {{ $labels.instance }} 内存使用率过高"
          description: "内存使用率超过 85%，当前值: {{ $value }}%"

      # 磁盘使用率过高
      - alert: HighDiskUsage
        expr: (1 - (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"})) * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "实例 {{ $labels.instance }} 磁盘使用率过高"
          description: "磁盘 {{ $labels.mountpoint }} 使用率超过 80%，当前值: {{ $value }}%"

      # 磁盘即将满
      - alert: DiskAlmostFull
        expr: (1 - (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"})) * 100 > 90
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "实例 {{ $labels.instance }} 磁盘即将满"
          description: "磁盘 {{ $labels.mountpoint }} 使用率超过 90%，当前值: {{ $value }}%"

  # =====================================================
  # 容器告警
  # =====================================================
  - name: containers
    rules:
      # 容器重启
      - alert: ContainerRestarted
        expr: increase(container_restart_count[1h]) > 3
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "容器 {{ $labels.name }} 频繁重启"
          description: "容器在过去 1 小时内重启了 {{ $value }} 次"

      # 容器 CPU 使用率过高
      - alert: ContainerHighCpu
        expr: (sum(rate(container_cpu_usage_seconds_total{name!=""}[5m])) by (name) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "容器 {{ $labels.name }} CPU 使用率过高"
          description: "容器 CPU 使用率超过 80%，当前值: {{ $value }}%"

      # 容器内存使用率过高
      - alert: ContainerHighMemory
        expr: (container_memory_usage_bytes{name!=""} / container_spec_memory_limit_bytes{name!=""}) * 100 > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "容器 {{ $labels.name }} 内存使用率过高"
          description: "容器内存使用率超过 85%，当前值: {{ $value }}%"

  # =====================================================
  # 应用服务告警
  # =====================================================
  - name: applications
    rules:
      # 服务不可用
      - alert: ServiceUnavailable
        expr: up{job="spring-boot-apps"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "服务 {{ $labels.instance }} 不可用"
          description: "服务已经不可用超过 1 分钟"

      # 请求错误率过高
      - alert: HighErrorRate
        expr: sum(rate(http_server_requests_seconds_count{status=~"5.."}[5m])) by (instance) / sum(rate(http_server_requests_seconds_count[5m])) by (instance) * 100 > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "服务 {{ $labels.instance }} 错误率过高"
          description: "5xx 错误率超过 5%，当前值: {{ $value }}%"

      # 响应时间过长
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket[5m])) by (le, instance)) > 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "服务 {{ $labels.instance }} 响应时间过长"
          description: "P95 响应时间超过 3 秒，当前值: {{ $value }}s"

      # JVM 堆内存使用率过高
      - alert: JvmHighHeapUsage
        expr: jvm_memory_used_bytes{area="heap"} / jvm_memory_max_bytes{area="heap"} * 100 > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "服务 {{ $labels.instance }} JVM 堆内存使用率过高"
          description: "JVM 堆内存使用率超过 85%，当前值: {{ $value }}%"

      # GC 时间过长
      - alert: HighGcTime
        expr: rate(jvm_gc_pause_seconds_sum[5m]) / rate(jvm_gc_pause_seconds_count[5m]) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "服务 {{ $labels.instance }} GC 时间过长"
          description: "平均 GC 暂停时间超过 500ms，当前值: {{ $value }}s"

  # =====================================================
  # 数据库告警
  # =====================================================
  - name: database
    rules:
      # MySQL 连接数过高
      - alert: MysqlHighConnections
        expr: mysql_global_status_threads_connected / mysql_global_variables_max_connections * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MySQL 连接数过高"
          description: "MySQL 连接数使用率超过 80%，当前值: {{ $value }}%"

      # MySQL 慢查询过多
      - alert: MysqlSlowQueries
        expr: rate(mysql_global_status_slow_queries[5m]) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MySQL 慢查询过多"
          description: "每秒慢查询数超过 1，当前值: {{ $value }}"

      # Redis 内存使用率过高
      - alert: RedisHighMemory
        expr: redis_memory_used_bytes / redis_memory_max_bytes * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Redis 内存使用率过高"
          description: "Redis 内存使用率超过 80%，当前值: {{ $value }}%"

      # Redis 连接数过高
      - alert: RedisHighConnections
        expr: redis_connected_clients > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Redis 连接数过高"
          description: "Redis 连接数超过 1000，当前值: {{ $value }}"

  # =====================================================
  # 消息队列告警
  # =====================================================
  - name: messaging
    rules:
      # Kafka 消费延迟
      - alert: KafkaConsumerLag
        expr: kafka_consumer_group_lag > 10000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Kafka 消费者组 {{ $labels.consumergroup }} 延迟过高"
          description: "消费延迟超过 10000 条消息，当前值: {{ $value }}"

      # Kafka Broker 不可用
      - alert: KafkaBrokerDown
        expr: kafka_brokers < 1
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Kafka Broker 不可用"
          description: "没有可用的 Kafka Broker"