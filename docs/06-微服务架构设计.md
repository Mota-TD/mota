# 摩塔 Mota - 微服务架构设计

> 版本：1.0  
> 日期：2026-01-07  
> 文档类型：技术架构文档

---

## 1. 架构概述

### 1.1 微服务拆分背景

原有的 `mota-project-service` 承担了过多职责，包含100+实体类，涵盖项目管理、AI功能、知识库、通知、日历等多个领域。随着业务发展，这种"巨石服务"模式带来了以下问题：

- **代码耦合度高**：不同领域的代码混杂在一起，难以维护
- **部署效率低**：任何小改动都需要重新部署整个服务
- **扩展性差**：无法针对特定功能进行独立扩展
- **团队协作困难**：多人同时开发容易产生冲突

### 1.2 拆分原则

1. **单一职责原则**：每个服务只负责一个业务领域
2. **高内聚低耦合**：服务内部高度内聚，服务之间松散耦合
3. **独立部署**：每个服务可以独立部署和扩展
4. **数据隔离**：每个服务拥有独立的数据库

---

## 2. 服务架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户层                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Web端     │  │   移动端    │  │   桌面端    │  │   API接入   │        │
│  │  (React)    │  │  (H5/App)   │  │  (Electron) │  │  (OpenAPI)  │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         API Gateway (8080)                                   │
│                      Spring Cloud Gateway                                    │
│  • 路由转发  • 负载均衡  • 限流熔断  • 认证鉴权  • 日志监控                │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
        ┌───────────────────────────┼───────────────────────────┐
        │           │               │               │           │
        ▼           ▼               ▼               ▼           ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ mota-auth   │ │mota-project │ │  mota-ai    │ │mota-knowledge│ │mota-notify │
│   (8081)    │ │   (8082)    │ │   (8083)    │ │   (8084)    │ │   (8085)   │
│ ─────────── │ │ ─────────── │ │ ─────────── │ │ ─────────── │ │ ─────────  │
│ • 用户认证  │ │ • 项目管理  │ │ • AI助手   │ │ • 知识库    │ │ • 站内通知 │
│ • 企业管理  │ │ • 任务管理  │ │ • 方案生成  │ │ • 文档管理  │ │ • 邮件推送 │
│ • 权限控制  │ │ • 里程碑    │ │ • 智能搜索  │ │ • 知识图谱  │ │ • 消息推送 │
│ • 成员管理  │ │ • 进度追踪  │ │ • 新闻推送  │ │ • 模板库    │ │ • WebSocket│
└─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘
        │               │               │               │               │
        └───────────────┴───────────────┴───────────────┴───────────────┘
                                        │
                        ┌───────────────┼───────────────┐
                        ▼               ▼               ▼
                ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
                │mota-calendar│ │   Nacos     │ │   Redis     │
                │   (8086)    │ │   (8848)    │ │   (6379)    │
                │ ─────────── │ │ ─────────── │ │ ─────────── │
                │ • 日程管理  │ │ • 服务注册  │ │ • 缓存      │
                │ • 日历订阅  │ │ • 配置中心  │ │ • 会话      │
                │ • 提醒服务  │ │             │ │ • 分布式锁  │
                └─────────────┘ └─────────────┘ └─────────────┘
```

---

## 3. 服务详细设计

### 3.1 服务清单

| 服务名称 | 端口 | 数据库 | Redis DB | 职责描述 |
|---------|------|--------|----------|----------|
| mota-gateway | 8080 | - | - | API网关，路由转发、认证鉴权 |
| mota-auth-service | 8081 | mota_auth | 0 | 用户认证、企业管理、权限控制 |
| mota-project-service | 8082 | mota | 1 | 项目管理、任务管理、里程碑 |
| mota-ai-service | 8083 | mota_ai | 2 | AI助手、方案生成、智能搜索、新闻推送 |
| mota-knowledge-service | 8084 | mota_knowledge | 3 | 知识库、文档管理、知识图谱、模板库 |
| mota-notify-service | 8085 | mota_notify | 4 | 站内通知、邮件、推送 |
| mota-calendar-service | 8086 | mota_calendar | 5 | 日程管理、日历订阅、提醒 |

### 3.2 mota-auth-service (认证服务)

**职责**：
- 用户注册、登录、登出
- JWT Token 生成与验证
- 企业创建与管理
- 企业成员邀请与管理
- 行业数据管理

**核心实体**：
- `User` - 用户
- `Enterprise` - 企业
- `EnterpriseMember` - 企业成员
- `EnterpriseInvitation` - 企业邀请
- `Industry` - 行业

**API 路由前缀**：`/api/auth/**`

### 3.3 mota-project-service (项目服务)

**职责**：
- 项目创建、编辑、删除
- 任务管理（CRUD、状态流转）
- 里程碑管理
- 子任务管理
- 任务依赖关系
- 任务评论
- 工作流管理
- 进度追踪

**核心实体**：
- `Project` - 项目
- `Task` - 任务
- `Subtask` - 子任务
- `Milestone` - 里程碑
- `TaskDependency` - 任务依赖
- `TaskComment` - 任务评论
- `WorkflowTemplate` - 工作流模板
- `WorkflowStatus` - 工作流状态
- `Checklist` - 检查清单
- `Deliverable` - 交付物

**API 路由前缀**：`/api/projects/**`, `/api/tasks/**`, `/api/milestones/**`

### 3.4 mota-ai-service (AI服务)

**职责**：
- AI 对话助手
- 方案自动生成
- 智能搜索（语义搜索）
- AI 新闻推送
- 工作建议生成
- 文档向量化
- OCR 识别
- 语音转文字

**核心实体**：
- `AIChatSession` - AI对话会话
- `AIChatMessage` - AI对话消息
- `AINews` - AI新闻
- `AIProposal` - AI方案
- `AIWorkSuggestion` - AI工作建议
- `AIDocumentVector` - 文档向量
- `AIDocumentSummary` - 文档摘要
- `AIOcrRecord` - OCR记录
- `AISpeechToText` - 语音转文字
- `SmartSearchLog` - 智能搜索日志

**API 路由前缀**：`/api/ai/**`, `/api/news/**`, `/api/search/**`

### 3.5 mota-knowledge-service (知识服务)

**职责**：
- 知识文件管理（上传、下载、预览）
- 文件分类管理
- 文件标签管理
- 文件版本控制
- 知识图谱构建与查询
- 模板库管理
- 文档统计分析

**核心实体**：
- `KnowledgeFile` - 知识文件
- `FileCategory` - 文件分类
- `FileTag` - 文件标签
- `KnowledgeFileTag` - 文件标签关联
- `DocumentVersion` - 文档版本
- `KnowledgeNode` - 知识图谱节点
- `KnowledgeEdge` - 知识图谱边
- `Template` - 模板
- `DocumentStatsDaily` - 文档统计
- `DocumentRanking` - 文档排行

**API 路由前缀**：`/api/knowledge/**`, `/api/documents/**`, `/api/templates/**`

### 3.6 mota-notify-service (通知服务)

**职责**：
- 站内通知管理
- 邮件发送
- 推送通知（App/Web）
- 通知配置管理
- WebSocket 实时推送

**核心实体**：
- `Notification` - 通知
- `NotificationConfig` - 通知配置
- `EmailRecord` - 邮件记录
- `PushRecord` - 推送记录

**API 路由前缀**：`/api/notifications/**`

### 3.7 mota-calendar-service (日历服务)

**职责**：
- 日历事件管理
- 日历订阅（iCal）
- 日历配置
- 事件提醒
- 参与者管理

**核心实体**：
- `CalendarEvent` - 日历事件
- `CalendarEventAttendee` - 事件参与者
- `CalendarConfig` - 日历配置
- `CalendarSubscription` - 日历订阅

**API 路由前缀**：`/api/calendar/**`

---

## 4. 服务间通信

### 4.1 通信方式

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           服务间通信架构                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  同步调用 (OpenFeign)                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │  mota-project-service ──────────────> mota-auth-service             │   │
│  │         │                              (获取用户信息)                │   │
│  │         │                                                            │   │
│  │         └──────────────────────────> mota-ai-service                │   │
│  │                                        (AI任务分解)                  │   │
│  │                                                                      │   │
│  │  mota-ai-service ────────────────────> mota-knowledge-service       │   │
│  │                                        (知识检索)                    │   │
│  │                                                                      │   │
│  │  mota-calendar-service ──────────────> mota-project-service         │   │
│  │                                        (获取任务日期)                │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  异步消息 (预留，可使用 Kafka/RabbitMQ)                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │  任务状态变更 ──────> 消息队列 ──────> mota-notify-service          │   │
│  │                                        (发送通知)                    │   │
│  │                                                                      │   │
│  │  文档上传完成 ──────> 消息队列 ──────> mota-ai-service              │   │
│  │                                        (向量化处理)                  │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 API 模块设计

为了实现服务间的类型安全调用，我们创建了独立的 API 模块：

```
mota-api/
├── mota-api-auth/          # 认证服务 API
│   └── AuthServiceClient   # Feign 客户端
├── mota-api-project/       # 项目服务 API
│   └── ProjectServiceClient
├── mota-api-ai/            # AI 服务 API
│   └── AIServiceClient
├── mota-api-knowledge/     # 知识服务 API
│   └── KnowledgeServiceClient
├── mota-api-notify/        # 通知服务 API
│   └── NotifyServiceClient
├── mota-api-calendar/      # 日历服务 API
│   └── CalendarServiceClient
└── mota-api-user/          # 用户服务 API
    └── UserServiceClient
```

**使用示例**：

```java
// 在 mota-project-service 中调用 mota-auth-service
@FeignClient(name = "mota-auth-service", path = "/api/auth")
public interface AuthServiceClient {
    
    @GetMapping("/users/{userId}")
    Result<UserDTO> getUserById(@PathVariable Long userId);
    
    @GetMapping("/users/current")
    Result<UserDTO> getCurrentUser();
}
```

---

## 5. 数据库设计

### 5.1 数据库隔离

每个微服务拥有独立的数据库，确保数据隔离：

| 数据库名 | 服务 | 说明 |
|---------|------|------|
| mota_auth | mota-auth-service | 用户、企业、权限数据 |
| mota | mota-project-service | 项目、任务、里程碑数据 |
| mota_ai | mota-ai-service | AI对话、方案、搜索数据 |
| mota_knowledge | mota-knowledge-service | 知识文件、图谱数据 |
| mota_notify | mota-notify-service | 通知、邮件、推送数据 |
| mota_calendar | mota-calendar-service | 日历事件、订阅数据 |

### 5.2 数据一致性

对于跨服务的数据一致性，采用以下策略：

1. **最终一致性**：通过消息队列实现异步同步
2. **Saga 模式**：对于复杂的分布式事务，使用 Saga 模式
3. **冗余存储**：关键数据在多个服务中冗余存储（如用户基本信息）

---

## 6. 网关路由配置

### 6.1 路由规则

```yaml
spring:
  cloud:
    gateway:
      routes:
        # 认证服务
        - id: auth-service
          uri: lb://mota-auth-service
          predicates:
            - Path=/api/auth/**
        
        # 项目服务
        - id: project-service
          uri: lb://mota-project-service
          predicates:
            - Path=/api/projects/**,/api/tasks/**,/api/milestones/**
        
        # AI 服务
        - id: ai-service
          uri: lb://mota-ai-service
          predicates:
            - Path=/api/ai/**,/api/news/**,/api/search/**
        
        # 知识服务
        - id: knowledge-service
          uri: lb://mota-knowledge-service
          predicates:
            - Path=/api/knowledge/**,/api/documents/**,/api/templates/**
        
        # 通知服务
        - id: notify-service
          uri: lb://mota-notify-service
          predicates:
            - Path=/api/notifications/**
        
        # 日历服务
        - id: calendar-service
          uri: lb://mota-calendar-service
          predicates:
            - Path=/api/calendar/**
```

---

## 7. 部署架构

### 7.1 Docker Compose 部署

开发环境使用 Docker Compose 进行部署：

```bash
# 启动基础设施（MySQL、Redis、Nacos）
docker-compose up -d mysql redis nacos

# 启动所有微服务
docker-compose --profile services up -d
```

### 7.2 服务端口分配

| 服务 | 端口 | 说明 |
|------|------|------|
| MySQL | 3306 | 数据库 |
| Redis | 6379 | 缓存 |
| Nacos | 8848 | 服务注册与配置中心 |
| mota-gateway | 8080 | API 网关 |
| mota-auth-service | 8081 | 认证服务 |
| mota-project-service | 8082 | 项目服务 |
| mota-ai-service | 8083 | AI 服务 |
| mota-knowledge-service | 8084 | 知识服务 |
| mota-notify-service | 8085 | 通知服务 |
| mota-calendar-service | 8086 | 日历服务 |

### 7.3 Kubernetes 部署

生产环境推荐使用 Kubernetes 部署：

```yaml
# 每个服务的 Deployment 配置
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mota-ai-service
spec:
  replicas: 2
  selector:
    matchLabels:
      app: mota-ai-service
  template:
    spec:
      containers:
        - name: mota-ai-service
          image: mota/mota-ai-service:latest
          ports:
            - containerPort: 8083
          resources:
            requests:
              memory: "512Mi"
              cpu: "500m"
            limits:
              memory: "1Gi"
              cpu: "1000m"
```

---

## 8. 监控与运维

### 8.1 健康检查

每个服务都提供健康检查端点：

- `/actuator/health` - 健康状态
- `/actuator/info` - 服务信息
- `/actuator/metrics` - 指标数据

### 8.2 日志收集

使用 ELK Stack 进行日志收集：

```
服务日志 ──> Filebeat ──> Logstash ──> Elasticsearch ──> Kibana
```

### 8.3 链路追踪

使用 SkyWalking 进行分布式链路追踪：

```
请求 ──> Gateway ──> Service A ──> Service B
           │            │            │
           └────────────┴────────────┘
                        │
                   SkyWalking
```

---

## 9. 迁移计划

### 9.1 迁移步骤

1. **阶段一：基础设施准备**
   - [x] 创建新的微服务模块
   - [x] 配置数据库初始化脚本
   - [x] 更新 Docker Compose 配置
   - [x] 更新网关路由配置

2. **阶段二：代码迁移**
   - [ ] 迁移 AI 相关代码到 mota-ai-service
   - [ ] 迁移知识库相关代码到 mota-knowledge-service
   - [ ] 迁移通知相关代码到 mota-notify-service
   - [ ] 迁移日历相关代码到 mota-calendar-service

3. **阶段三：服务间通信**
   - [ ] 实现 Feign 客户端
   - [ ] 添加服务降级处理
   - [ ] 配置熔断器

4. **阶段四：测试与上线**
   - [ ] 单元测试
   - [ ] 集成测试
   - [ ] 灰度发布
   - [ ] 全量上线

### 9.2 回滚方案

如果迁移过程中出现问题，可以通过以下方式回滚：

1. 网关路由切换回原服务
2. 数据库数据同步回主库
3. 停止新服务，启动原服务

---

## 10. 总结

通过微服务拆分，我们实现了：

1. **职责清晰**：每个服务只负责一个业务领域
2. **独立部署**：可以针对特定服务进行独立部署和扩展
3. **技术灵活**：不同服务可以使用不同的技术栈
4. **团队协作**：不同团队可以独立开发不同服务
5. **故障隔离**：单个服务故障不会影响整个系统

---

*文档结束*