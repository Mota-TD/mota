# 摩塔 Mota - 最佳技术架构方案

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档版本 | v1.1 |
| 创建日期 | 2026-01-07 |
| 更新日期 | 2026-01-07 |
| 适用范围 | 用户Web端、移动App、运营管理后台 |
| 目标 | 构建可扩展、高可用、易维护的AI原生项目管理平台 |

---

## 一、现状分析与问题总结

### 1.1 现有架构概述

当前系统采用 Spring Cloud 微服务架构，包含以下服务：

| 服务名称 | 职责 | 问题 |
|---------|------|------|
| mota-gateway | API网关 | 路由配置复杂，缺少限流熔断 |
| mota-auth-service | 认证授权 | 功能单一，缺少多租户支持 |
| mota-user-service | 用户管理 | 与认证服务边界模糊 |
| mota-project-service | 项目管理 | **职责过重**，包含40+控制器 |
| mota-ai-service | AI功能 | 与project-service功能重复 |
| mota-knowledge-service | 知识管理 | 功能分散在多个服务 |
| mota-notify-service | 通知服务 | 功能不完整 |
| mota-calendar-service | 日历服务 | 依赖project-service数据 |

### 1.2 核心问题

1. **服务职责不清晰**：mota-project-service 承担过多职责
2. **代码重复**：AI功能分散在多个服务中
3. **缺少多端支持**：仅有Web端，无App和管理后台
4. **缺少多租户架构**：无法支持SaaS模式
5. **前端架构单一**：仅React单体应用，无法复用
6. **缺少实时通信**：WebSocket支持不完善
7. **监控日志不完善**：缺少完整的监控、日志体系

---

## 二、架构设计原则

### 2.1 核心原则

| 原则 | 说明 |
|------|------|
| **领域驱动设计(DDD)** | 按业务领域划分服务边界 |
| **单一职责** | 每个服务只负责一个业务领域 |
| **API优先** | 先设计API，再实现功能 |
| **可观测性** | 完善的监控、日志、追踪体系 |
| **多端复用** | 统一API，多端共享业务逻辑 |
| **AI原生** | AI能力作为基础设施 |

### 2.2 技术选型原则

- **成熟稳定**：优先选择经过大规模验证的技术
- **社区活跃**：有活跃的开源社区支持
- **团队熟悉**：考虑团队技术栈和学习成本
- **生态完善**：有完善的工具链和生态系统

---

## 三、整体架构设计

### 3.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                   客户端层                                        │
├─────────────────┬─────────────────┬─────────────────┬─────────────────────────────┤
│   用户Web端      │    移动App      │   运营管理后台    │      开放API              │
│  (React/Next.js) │ (React Native)  │   (React/Ant)   │    (OpenAPI)              │
└────────┬────────┴────────┬────────┴────────┬────────┴────────────┬──────────────┘
         │                 │                 │                     │
         └─────────────────┴─────────────────┴─────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              接入层 (Ingress)                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │
│  │   Nginx     │  │    CDN      │  │    WAF      │  │   SSL/TLS Termination   │ │
│  │  (负载均衡)  │  │  (静态资源)  │  │  (安全防护)  │  │      (证书管理)          │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              网关层 (API Gateway)                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        Spring Cloud Gateway                              │   │
│  │  • 路由转发  • 认证鉴权  • 限流熔断  • 协议转换  • 日志追踪  • API版本管理   │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                     WebSocket Gateway (独立)                             │   │
│  │  • 实时消息  • 在线状态  • 协作编辑  • 通知推送                            │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              BFF层 (Backend For Frontend)                        │
├─────────────────┬─────────────────┬─────────────────┬─────────────────────────────┤
│   User BFF      │    App BFF      │   Admin BFF     │      Open API BFF         │
│  (用户端聚合)    │  (移动端聚合)    │  (管理端聚合)    │     (开放接口聚合)         │
│  Node.js/NestJS │  Node.js/NestJS │  Node.js/NestJS │     Node.js/NestJS        │
└────────┬────────┴────────┬────────┴────────┬────────┴────────────┬──────────────┘
         │                 │                 │                     │
         └─────────────────┴─────────────────┴─────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              业务服务层 (Microservices)                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │ 用户服务     │  │ 项目服务     │  │ 任务服务     │  │ 协作服务     │            │
│  │ user-svc    │  │ project-svc │  │ task-svc    │  │ collab-svc  │            │
│  │             │  │             │  │             │  │             │            │
│  │ • 用户管理   │  │ • 项目CRUD  │  │ • 任务管理   │  │ • 文档协作   │            │
│  │ • 认证授权   │  │ • 成员管理   │  │ • 子任务    │  │ • 实时编辑   │            │
│  │ • 组织架构   │  │ • 里程碑    │  │ • 依赖关系   │  │ • 评论批注   │            │
│  │ • 权限管理   │  │ • 进度跟踪   │  │ • 工作流    │  │ • 版本控制   │            │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │
│                                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │ 知识服务     │  │ AI服务      │  │ 通知服务     │  │ 日历服务     │            │
│  │ knowledge   │  │ ai-svc      │  │ notify-svc  │  │ calendar    │            │
│  │             │  │             │  │             │  │             │            │
│  │ • 文件管理   │  │ • AI对话    │  │ • 站内通知   │  │ • 日程管理   │            │
│  │ • 知识图谱   │  │ • 方案生成   │  │ • 邮件推送   │  │ • 任务同步   │            │
│  │ • 模板管理   │  │ • 智能搜索   │  │ • App推送   │  │ • 订阅管理   │            │
│  │ • 统计分析   │  │ • 新闻推送   │  │ • 聚合分类   │  │ • 提醒功能   │            │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │
│                                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                             │
│  │ 报表服务     │  │ 搜索服务     │  │ 文件服务     │                             │
│  │ report-svc  │  │ search-svc  │  │ file-svc    │                             │
│  │             │  │             │  │             │                             │
│  │ • 数据统计   │  │ • 全文检索   │  │ • 文件上传   │                             │
│  │ • 报表生成   │  │ • 语义搜索   │  │ • 文件预览   │                             │
│  │ • 数据导出   │  │ • 向量检索   │  │ • 缩略图    │                             │
│  │ • 仪表盘    │  │ • 搜索建议   │  │ • CDN分发   │                             │
│  └─────────────┘  └─────────────┘  └─────────────┘                             │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         租户服务 (tenant-svc)                            │   │
│  │  • 租户管理  • 套餐管理  • 计费计量  • 资源隔离  • 配置管理                  │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              基础设施层 (Infrastructure)                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                           数据存储                                       │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐            │   │
│  │  │  MySQL    │  │   Redis   │  │ Elasticsearch│ │  Milvus   │            │   │
│  │  │ (主数据库) │  │  (缓存)    │  │  (全文检索)  │  │ (向量库)   │            │   │
│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘            │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐                           │   │
│  │  │  MinIO    │  │  MongoDB  │  │ ClickHouse │                           │   │
│  │  │ (对象存储) │  │ (文档存储) │  │  (分析库)   │                           │   │
│  │  └───────────┘  └───────────┘  └───────────┘                           │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                           消息队列                                       │   │
│  │  ┌───────────────────────────────────────────────────────────────────┐ │   │
│  │  │                    Apache Kafka                                    │ │   │
│  │  │  • 事件驱动  • 异步处理  • 日志收集  • 数据同步                       │ │   │
│  │  └───────────────────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                           服务治理                                       │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐            │   │
│  │  │   Nacos   │  │  Sentinel │  │  Seata    │  │  SkyWalking│            │   │
│  │  │ (注册配置) │  │ (限流熔断) │  │ (分布式事务)│  │  (链路追踪) │            │   │
│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘            │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                           AI基础设施                                     │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐            │   │
│  │  │ LLM Gateway│ │ Embedding │  │ RAG Engine │  │ Model Hub │            │   │
│  │  │ (模型网关) │  │ (向量化)   │  │ (检索增强)  │  │ (模型管理) │            │   │
│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘            │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              监控运维层 (Monitoring)                             │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐    │
│  │ Prometheus│  │  Grafana  │  │   ELK     │  │ SkyWalking│  │AlertManager│    │
│  │  (指标)    │  │ (可视化)   │  │  (日志)   │  │  (追踪)    │  │  (告警)    │    │
│  └───────────┘  └───────────┘  └───────────┘  └───────────┘  └───────────┘    │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 多端架构设计

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              多端架构                                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         共享层 (Shared)                                  │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐            │   │
│  │  │ API Types │  │ Constants │  │  Utils    │  │ Validators │            │   │
│  │  │ (类型定义) │  │  (常量)    │  │ (工具函数) │  │  (校验)    │            │   │
│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘            │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                   │                                           │
│         ┌──────────────────────────┼──────────────────────────┐               │
│         │                          │                          │               │
│         ▼                          ▼                          ▼               │
│  ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐       │
│  │   用户Web端      │      │    移动App      │      │   运营管理后台    │       │
│  │                 │      │                 │      │                 │       │
│  │ ┌─────────────┐ │      │ ┌─────────────┐ │      │ ┌─────────────┐ │       │
│  │ │  Next.js    │ │      │ │React Native │ │      │ │  React      │ │       │
│  │ │  (SSR/SSG)  │ │      │ │  (Expo)     │ │      │ │  (Ant Pro)  │ │       │
│  │ └─────────────┘ │      │ └─────────────┘ │      │ └─────────────┘ │       │
│  │                 │      │                 │      │                 │       │
│  │ ┌─────────────┐ │      │ ┌─────────────┐ │      │ ┌─────────────┐ │       │
│  │ │  Zustand    │ │      │ │  Zustand    │ │      │ │  Zustand    │ │       │
│  │ │  (状态管理)  │ │      │ │  (状态管理)  │ │      │ │  (状态管理)  │ │       │
│  │ └─────────────┘ │      │ └─────────────┘ │      │ └─────────────┘ │       │
│  │                 │      │                 │      │                 │       │
│  │ ┌─────────────┐ │      │ ┌─────────────┐ │      │ ┌─────────────┐ │       │
│  │ │  TanStack   │ │      │ │  TanStack   │ │      │ │  TanStack   │ │       │
│  │ │  Query      │ │      │ │  Query      │ │      │ │  Query      │ │       │
│  │ └─────────────┘ │      │ └─────────────┘ │      │ └─────────────┘ │       │
│  │                 │      │                 │      │                 │       │
│  │ 功能模块:       │      │ 功能模块:       │      │ 功能模块:       │       │
│  │ • 项目管理      │      │ • 任务查看      │      │ • 用户管理      │       │
│  │ • 任务管理      │      │ • 通知推送      │      │ • 租户管理      │       │
│  │ • 知识库       │      │ • 日程提醒      │      │ • 数据统计      │       │
│  │ • AI功能       │      │ • 快速操作      │      │ • 系统配置      │       │
│  │ • 文档协作      │      │ • 离线支持      │      │ • 运营分析      │       │
│  │ • 日程管理      │      │ • 扫码功能      │      │ • 内容审核      │       │
│  └─────────────────┘      └─────────────────┘      └─────────────────┘       │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、技术栈选型

### 4.1 后端技术栈

#### 4.1.1 核心框架

| 层级 | 技术选型 | 版本 | 说明 |
|------|---------|------|------|
| 语言 | Java | 21 LTS | 长期支持版本，虚拟线程支持 |
| 框架 | Spring Boot | 3.2.x | 主流微服务框架 |
| 微服务 | Spring Cloud | 2023.x | 微服务全家桶 |
| 服务治理 | Spring Cloud Alibaba | 2023.x | Nacos/Sentinel/Seata |

#### 4.1.2 数据存储

| 用途 | 技术选型 | 版本 | 说明 |
|------|---------|------|------|
| 关系数据库 | MySQL | 8.0+ | 主数据存储，支持分库分表 |
| 缓存 | Redis | 7.x | 缓存、分布式锁、会话 |
| 搜索引擎 | Elasticsearch | 8.x | 全文检索、日志分析 |
| 向量数据库 | Milvus | 2.x | AI向量存储和检索 |
| 对象存储 | MinIO | Latest | 文件存储，兼容S3 |
| 文档数据库 | MongoDB | 7.x | 非结构化数据存储 |
| 分析数据库 | ClickHouse | Latest | OLAP分析、报表 |

#### 4.1.3 消息队列

| 用途 | 技术选型 | 版本 | 说明 |
|------|---------|------|------|
| 消息队列 | Apache Kafka | 3.x | 事件驱动、日志收集 |
| 延迟队列 | Redis | 7.x | 定时任务、延迟消息 |

#### 4.1.4 服务治理

| 用途 | 技术选型 | 版本 | 说明 |
|------|---------|------|------|
| 注册中心 | Nacos | 2.x | 服务注册与发现 |
| 配置中心 | Nacos | 2.x | 配置管理 |
| 限流熔断 | Sentinel | 1.8.x | 流量控制、熔断降级 |
| 分布式事务 | Seata | 2.x | 分布式事务管理 |
| 链路追踪 | SkyWalking | 9.x | APM、链路追踪 |

#### 4.1.5 API网关

| 用途 | 技术选型 | 版本 | 说明 |
|------|---------|------|------|
| API网关 | Spring Cloud Gateway | 4.x | 与Spring生态集成良好 |
| WebSocket | 独立服务 | - | 基于Netty实现 |

### 4.2 前端技术栈

#### 4.2.1 用户Web端

| 层级 | 技术选型 | 版本 | 说明 |
|------|---------|------|------|
| 框架 | Next.js | 14.x | SSR/SSG支持，SEO友好 |
| 语言 | TypeScript | 5.x | 类型安全 |
| UI组件 | Ant Design | 5.x | 企业级组件库 |
| 状态管理 | Zustand | 4.x | 轻量级状态管理 |
| 数据请求 | TanStack Query | 5.x | 服务端状态管理 |
| 图表 | ECharts | 5.x | 数据可视化 |
| 编辑器 | Monaco Editor | Latest | 代码编辑器 |
| 协作编辑 | Yjs | Latest | CRDT实时协作 |

#### 4.2.2 移动App

| 层级 | 技术选型 | 版本 | 说明 |
|------|---------|------|------|
| 框架 | React Native | 0.73+ | 跨平台移动开发 |
| 工具链 | Expo | 50.x | 简化开发流程 |
| 导航 | React Navigation | 6.x | 路由导航 |
| UI组件 | React Native Paper | 5.x | Material Design |
| 状态管理 | Zustand | 4.x | 与Web端统一 |
| 推送 | Expo Notifications | Latest | 消息推送 |
| 离线存储 | WatermelonDB | Latest | 离线数据同步 |

#### 4.2.3 运营管理后台

| 层级 | 技术选型 | 版本 | 说明 |
|------|---------|------|------|
| 框架 | React | 18.x | 单页应用 |
| 脚手架 | Ant Design Pro | 6.x | 企业级中后台 |
| 语言 | TypeScript | 5.x | 类型安全 |
| 状态管理 | Zustand | 4.x | 轻量级状态管理 |
| 图表 | ECharts | 5.x | 数据可视化 |
| 表格 | ProTable | Latest | 高级表格组件 |

### 4.3 AI技术栈

| 用途 | 技术选型 | 说明 |
|------|---------|------|
| LLM网关 | LiteLLM | 统一多模型调用接口 |
| 向量化 | OpenAI Embeddings / BGE | 文本向量化 |
| RAG框架 | LangChain | 检索增强生成 |
| 模型支持 | GPT-4/Claude/通义千问/文心一言 | 多模型支持 |
| OCR | PaddleOCR | 文字识别 |
| 语音转文字 | Whisper | 语音识别 |

### 4.4 监控运维技术栈

| 用途 | 技术选型 | 版本 | 说明 |
|------|---------|------|------|
| 指标监控 | Prometheus | Latest | 指标采集和存储 |
| 可视化 | Grafana | Latest | 监控仪表盘 |
| 日志收集 | ELK Stack | 8.x | 日志收集分析 |
| 链路追踪 | SkyWalking | 9.x | APM、链路追踪 |
| 告警 | AlertManager | Latest | 告警管理 |

---

## 五、微服务详细设计

### 5.1 服务划分

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              微服务划分                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         核心业务服务                                     │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  mota-user-service (用户服务)                                           │   │
│  │  ├── 用户注册/登录/认证                                                  │   │
│  │  ├── 用户信息管理                                                       │   │
│  │  ├── 组织架构管理                                                       │   │
│  │  ├── 角色权限管理                                                       │   │
│  │  └── SSO/OAuth2集成                                                     │   │
│  │                                                                         │   │
│  │  mota-tenant-service (租户服务) [新增]                                   │   │
│  │  ├── 租户管理                                                           │   │
│  │  ├── 套餐管理                                                           │   │
│  │  ├── 计费计量                                                           │   │
│  │  ├── 资源配额                                                           │   │
│  │  └── 租户配置                                                           │   │
│  │                                                                         │   │
│  │  mota-project-service (项目服务)                                        │   │
│  │  ├── 项目CRUD                                                           │   │
│  │  ├── 项目成员管理                                                       │   │
│  │  ├── 里程碑管理                                                         │   │
│  │  ├── 进度跟踪                                                           │   │
│  │  └── 项目模板                                                           │   │
│  │                                                                         │   │
│  │  mota-task-service (任务服务) [从project-service拆分]                    │   │
│  │  ├── 任务CRUD                                                           │   │
│  │  ├── 子任务管理                                                         │   │
│  │  ├── 任务依赖                                                           │   │
│  │  ├── 工作流管理                                                         │   │
│  │  ├── 检查清单                                                           │   │
│  │  └── 任务模板                                                           │   │
│  │                                                                         │   │
│  │  mota-collab-service (协作服务) [新增]                                   │   │
│  │  ├── 文档协作                                                           │   │
│  │  ├── 实时编辑(CRDT)                                                     │   │
│  │  ├── 评论批注                                                           │   │
│  │  ├── 版本控制                                                           │   │
│  │  └── 在线状态                                                           │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         支撑业务服务                                     │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  mota-knowledge-service (知识服务)                                      │   │
│  │  ├── 文件管理                                                           │   │
│  │  ├── 知识图谱                                                           │   │
│  │  ├── 模板管理                                                           │   │
│  │  ├── 分类标签                                                           │   │
│  │  └── 统计分析                                                           │   │
│  │                                                                         │   │
│  │  mota-ai-service (AI服务)                                               │   │
│  │  ├── AI对话                                                             │   │
│  │  ├── 方案生成                                                           │   │
│  │  ├── 智能搜索                                                           │   │
│  │  ├── 新闻推送                                                           │   │
│  │  ├── 多模型管理                                                         │   │
│  │  └── AI知识库                                                           │   │
│  │                                                                         │   │
│  │  mota-notify-service (通知服务)                                         │   │
│  │  ├── 站内通知                                                           │   │
│  │  ├── 邮件推送                                                           │   │
│  │  ├── App推送                                                            │   │
│  │  ├── 企微/钉钉推送                                                      │   │
│  │  ├── 通知聚合                                                           │   │
│  │  └── 订阅管理                                                           │   │
│  │                                                                         │   │
│  │  mota-calendar-service (日历服务)                                       │   │
│  │  ├── 日程管理                                                           │   │
│  │  ├── 任务同步                                                           │   │
│  │  ├── 订阅管理                                                           │   │
│  │  └── 提醒功能                                                           │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         基础设施服务                                     │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  mota-search-service (搜索服务) [新增]                                   │   │
│  │  ├── 全文检索                                                           │   │
│  │  ├── 语义搜索                                                           │   │
│  │  ├── 向量检索                                                           │   │
│  │  ├── 搜索建议                                                           │   │
│  │  └── 搜索统计                                                           │   │
│  │                                                                         │   │
│  │  mota-file-service (文件服务) [新增]                                     │   │
│  │  ├── 文件上传                                                           │   │
│  │  ├── 文件预览                                                           │   │
│  │  ├── 缩略图生成                                                         │   │
│  │  ├── 格式转换                                                           │   │
│  │  └── CDN分发                                                            │   │
│  │                                                                         │   │
│  │  mota-report-service (报表服务) [新增]                                   │   │
│  │  ├── 数据统计                                                           │   │
│  │  ├── 报表生成                                                           │   │
│  │  ├── 数据导出                                                           │   │
│  │  └── 仪表盘                                                             │   │
│  │                                                                         │   │
│  │  mota-job-service (任务调度服务) [新增]                                  │   │
│  │  ├── 定时任务                                                           │   │
│  │  ├── 延迟任务                                                           │   │
│  │  ├── 任务编排                                                           │   │
│  │  └── 任务监控                                                           │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         BFF服务                                         │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  mota-user-bff (用户端BFF)                                              │   │
│  │  ├── 接口聚合                                                           │   │
│  │  ├── 数据裁剪                                                           │   │
│  │  └── 缓存优化                                                           │   │
│  │                                                                         │   │
│  │  mota-app-bff (移动端BFF)                                               │   │
│  │  ├── 接口聚合                                                           │   │
│  │  ├── 数据压缩                                                           │   │
│  │  └── 离线支持                                                           │   │
│  │                                                                         │   │
│  │  mota-admin-bff (管理端BFF)                                             │   │
│  │  ├── 接口聚合                                                           │   │
│  │  ├── 权限校验                                                           │   │
│  │  └── 数据统计                                                           │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 服务通信设计

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              服务通信模式                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         同步通信 (HTTP/gRPC)                             │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  场景：                                                                  │   │
│  │  • 需要立即返回结果的请求                                                 │   │
│  │  • 数据查询操作                                                          │   │
│  │  • 简单的CRUD操作                                                        │   │
│  │                                                                         │   │
│  │  实现：                                                                  │   │
│  │  • OpenFeign (HTTP)                                                     │   │
│  │  • gRPC (高性能场景)                                                     │   │
│  │                                                                         │   │
│  │  示例：                                                                  │   │
│  │  ┌─────────────┐    HTTP/gRPC    ┌─────────────┐                       │   │
│  │  │ task-svc    │ ───────────────▶│ user-svc    │                       │   │
│  │  │ (获取用户)   │◀─────────────── │ (返回用户)   │                       │   │
│  │  └─────────────┘                 └─────────────┘                       │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         异步通信 (Kafka)                                 │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  场景：                                                                  │   │
│  │  • 不需要立即返回结果                                                    │   │
│  │  • 耗时操作                                                             │   │
│  │  • 事件通知                                                             │   │
│  │  • 数据同步                                                             │   │
│  │                                                                         │   │
│  │  事件类型：                                                              │   │
│  │  • 领域事件 (Domain Events)                                             │   │
│  │  • 集成事件 (Integration Events)                                        │   │
│  │                                                                         │   │
│  │  示例：                                                                  │   │
│  │  ┌─────────────┐                 ┌─────────────┐                       │   │
│  │  │ task-svc    │    Kafka        │ notify-svc  │                       │   │
│  │  │ (任务完成)   │ ──────────────▶ │ (发送通知)   │                       │   │
│  │  └─────────────┘  TaskCompleted  └─────────────┘                       │   │
│  │                        │                                                │   │
│  │                        │         ┌─────────────┐                       │   │
│  │                        └────────▶│ report-svc  │                       │   │
│  │                                  │ (更新统计)   │                       │   │
│  │                                  └─────────────┘                       │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         事件主题设计                                     │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  Topic命名规范: mota.{domain}.{event-type}                              │   │
│  │                                                                         │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │   │
│  │  │ Topic                        │ 说明                             │   │   │
│  │  ├─────────────────────────────────────────────────────────────────┤   │   │
│  │  │ mota.user.created            │ 用户创建事件                      │   │   │
│  │  │ mota.user.updated            │ 用户更新事件                      │   │   │
│  │  │ mota.project.created         │ 项目创建事件                      │   │   │
│  │  │ mota.project.member-added    │ 项目成员添加事件                   │   │   │
│  │  │ mota.task.created            │ 任务创建事件                      │   │   │
│  │  │ mota.task.completed          │ 任务完成事件                      │   │   │
│  │  │ mota.task.assigned           │ 任务分配事件                      │   │   │
│  │  │ mota.document.updated        │ 文档更新事件                      │   │   │
│  │  │ mota.notification.send       │ 通知发送事件                      │   │   │
│  │  │ mota.ai.request              │ AI请求事件                       │   │   │
│  │  └─────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 数据库设计

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              数据库架构                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         数据库分库策略                                   │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  原则：每个微服务独立数据库，数据隔离                                      │   │
│  │                                                                         │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │   │
│  │  │ 服务                │ 数据库              │ 说明                │   │   │
│  │  ├─────────────────────────────────────────────────────────────────┤   │   │
│  │  │ mota-user-service   │ mota_user          │ 用户、组织、权限     │   │   │
│  │  │ mota-tenant-service │ mota_tenant        │ 租户、套餐、计费     │   │   │
│  │  │ mota-project-service│ mota_project       │ 项目、里程碑        │   │   │
│  │  │ mota-task-service   │ mota_task          │ 任务、子任务、工作流  │   │   │
│  │  │ mota-collab-service │ mota_collab        │ 文档、协作、版本     │   │   │
│  │  │ mota-knowledge-svc  │ mota_knowledge     │ 知识、模板、分类     │   │   │
│  │  │ mota-ai-service     │ mota_ai            │ AI对话、模型配置     │   │   │
│  │  │ mota-notify-service │ mota_notify        │ 通知、订阅、推送     │   │   │
│  │  │ mota-calendar-svc   │ mota_calendar      │ 日程、提醒          │   │   │
│  │  │ mota-report-service │ mota_report        │ 报表、统计          │   │   │
│  │  └─────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         多租户数据隔离                                   │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  方案：共享数据库 + 租户ID字段隔离                                        │   │
│  │                                                                         │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │   │
│  │  │                                                                 │   │   │
│  │  │  CREATE TABLE task (                                            │   │   │
│  │  │      id BIGINT PRIMARY KEY,                                     │   │   │
│  │  │      tenant_id BIGINT NOT NULL,  -- 租户ID                       │   │   │
│  │  │      project_id BIGINT NOT NULL,                                │   │   │
│  │  │      title VARCHAR(255) NOT NULL,                               │   │   │
│  │  │      ...                                                        │   │   │
│  │  │      INDEX idx_tenant_id (tenant_id),                           │   │   │
│  │  │      INDEX idx_tenant_project (tenant_id, project_id)           │   │   │
│  │  │  );                                                             │   │   │
│  │  │                                                                 │   │   │
│  │  │  -- 所有查询自动添加租户条件                                       │   │   │
│  │  │  SELECT * FROM task WHERE tenant_id = ? AND ...                 │   │   │
│  │  │                                                                 │   │   │
│  │  └─────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                         │   │
│  │  实现方式：                                                             │   │
│  │  • MyBatis-Plus 多租户插件                                              │   │
│  │  • 自动注入租户ID                                                       │   │
│  │  • 自动添加租户查询条件                                                  │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         分库分表策略                                     │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  使用 ShardingSphere 进行分库分表                                        │   │
│  │                                                                         │   │
│  │  分片策略：                                                              │   │
│  │  • 按租户ID分库（大租户独立库）                                           │   │
│  │  • 按时间分表（日志、历史数据）                                           │   │
│  │                                                                         │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │   │
│  │  │ 表                  │ 分片键        │ 分片策略                  │   │   │
│  │  ├─────────────────────────────────────────────────────────────────┤   │   │
│  │  │ task               │ tenant_id     │ 按租户ID取模              │   │   │
│  │  │ task_log           │ created_at    │ 按月分表                  │   │   │
│  │  │ notification       │ tenant_id     │ 按租户ID取模              │   │   │
│  │  │ ai_chat_history    │ created_at    │ 按月分表                  │   │   │
│  │  └─────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 六、多端详细设计

### 6.1 用户Web端 (Next.js)

```
mota-web/
├── app/                          # App Router
│   ├── (auth)/                   # 认证相关页面
│   │   ├── login/
│   │   ├── register/
│   │   └── forgot-password/
│   ├── (console)/                # 控制台页面
│   │   ├── dashboard/
│   │   ├── projects/
│   │   │   ├── [id]/
│   │   │   └── create/
│   │   ├── tasks/
│   │   ├── calendar/
│   │   ├── knowledge/
│   │   ├── ai/
│   │   │   ├── assistant/
│   │   │   ├── proposal/
│   │   │   └── news/
│   │   ├── documents/
│   │   ├── notifications/
│   │   └── settings/
│   ├── api/                      # API Routes (BFF)
│   │   ├── auth/
│   │   ├── projects/
│   │   └── ai/
│   ├── layout.tsx
│   └── page.tsx
├── components/                   # 组件
│   ├── ui/                       # 基础UI组件
│   ├── business/                 # 业务组件
│   │   ├── project/
│   │   ├── task/
│   │   ├── calendar/
│   │   └── ai/
│   └── layout/                   # 布局组件
├── hooks/                        # 自定义Hooks
├── lib/                          # 工具库
│   ├── api/                      # API客户端
│   ├── utils/
│   └── constants/
├── stores/                       # 状态管理
│   ├── auth.ts
│   ├── project.ts
│   └── ui.ts
├── types/                        # 类型定义
├── styles/                       # 样式
└── public/                       # 静态资源
```

### 6.2 移动App (React Native + Expo)

```
mota-app/
├── app/                          # Expo Router
│   ├── (auth)/
│   │   ├── login.tsx
│   │   └── register.tsx
│   ├── (tabs)/                   # 底部Tab导航
│   │   ├── index.tsx             # 首页/仪表盘
│   │   ├── tasks.tsx             # 我的任务
│   │   ├── calendar.tsx          # 日程
│   │   ├── notifications.tsx     # 通知
│   │   └── profile.tsx           # 个人中心
│   ├── project/
│   │   └── [id].tsx
│   ├── task/
│   │   └── [id].tsx
│   ├── _layout.tsx
│   └── +not-found.tsx
├── components/
│   ├── ui/                       # 基础组件
│   ├── business/                 # 业务组件
│   └── layout/                   # 布局组件
├── hooks/
├── lib/
│   ├── api/
│   ├── storage/                  # 本地存储
│   └── sync/                     # 离线同步
├── stores/
├── types/
└── assets/
```

**移动端核心功能：**

| 功能模块 | 说明 |
|---------|------|
| 任务管理 | 查看、更新任务状态、快速操作 |
| 通知推送 | 实时推送、消息中心 |
| 日程提醒 | 日程查看、提醒通知 |
| 快速操作 | 扫码、语音输入、快速创建 |
| 离线支持 | 离线查看、离线操作、自动同步 |
| 协作功能 | 评论、@提醒、文件查看 |

### 6.3 运营管理后台 (Ant Design Pro)

```
mota-admin/
├── src/
│   ├── pages/
│   │   ├── dashboard/            # 运营仪表盘
│   │   │   ├── overview/         # 总览
│   │   │   ├── analytics/        # 数据分析
│   │   │   └── realtime/         # 实时监控
│   │   ├── tenant/               # 租户管理
│   │   │   ├── list/             # 租户列表
│   │   │   ├── detail/           # 租户详情
│   │   │   └── billing/          # 计费管理
│   │   ├── user/                 # 用户管理
│   │   │   ├── list/             # 用户列表
│   │   │   ├── audit/            # 用户审核
│   │   │   └── feedback/         # 用户反馈
│   │   ├── content/              # 内容管理
│   │   │   ├── news/             # 新闻管理
│   │   │   ├── template/         # 模板管理
│   │   │   └── audit/            # 内容审核
│   │   ├── ai/                   # AI管理
│   │   │   ├── model/            # 模型管理
│   │   │   ├── usage/            # 使用统计
│   │   │   └── cost/             # 成本控制
│   │   ├── system/               # 系统管理
│   │   │   ├── config/           # 系统配置
│   │   │   ├── log/              # 操作日志
│   │   │   └── monitor/          # 系统监控
│   │   └── settings/             # 设置
│   ├── components/
│   ├── services/
│   ├── models/
│   └── utils/
├── config/
└── public/
```

**管理后台核心功能：**

| 功能模块 | 说明 |
|---------|------|
| 运营仪表盘 | 用户统计、活跃度、收入分析 |
| 租户管理 | 租户CRUD、套餐管理、计费管理 |
| 用户管理 | 用户列表、审核、封禁 |
| 内容管理 | 新闻、模板、内容审核 |
| AI管理 | 模型配置、使用统计、成本控制 |
| 系统管理 | 配置、日志、监控 |

---

## 七、AI架构设计

### 7.1 AI服务架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              AI服务架构                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         AI网关层                                         │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │   │
│  │  │                      LLM Gateway (LiteLLM)                       │   │   │
│  │  │                                                                 │   │   │
│  │  │  • 统一API接口                                                   │   │   │
│  │  │  • 多模型路由                                                    │   │   │
│  │  │  • 负载均衡                                                      │   │   │
│  │  │  • 故障转移                                                      │   │   │
│  │  │  • 成本控制                                                      │   │   │
│  │  │  • 使用统计                                                      │   │   │
│  │  │                                                                 │   │   │
│  │  └─────────────────────────────────────────────────────────────────┘   │   │
│  │                              │                                         │   │
│  │         ┌────────────────────┼────────────────────┐                   │   │
│  │         │                    │                    │                   │   │
│  │         ▼                    ▼                    ▼                   │   │
│  │  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐           │   │
│  │  │   OpenAI    │      │  Anthropic  │      │   阿里云     │           │   │
│  │  │  GPT-4/3.5  │      │   Claude    │      │  通义千问    │           │   │
│  │  └─────────────┘      └─────────────┘      └─────────────┘           │   │
│  │         │                    │                    │                   │   │
│  │         ▼                    ▼                    ▼                   │   │
│  │  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐           │   │
│  │  │    百度     │      │   本地模型   │      │   其他模型   │           │   │
│  │  │  文心一言   │      │  (私有化)    │      │             │           │   │
│  │  └─────────────┘      └─────────────┘      └─────────────┘           │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         RAG引擎                                         │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │   │
│  │  │                                                                 │   │   │
│  │  │  ┌───────────┐    ┌───────────┐    ┌───────────┐              │   │   │
│  │  │  │ 文档解析   │───▶│ 文本分块   │───▶│ 向量化    │              │   │   │
│  │  │  │           │    │           │    │ Embedding │              │   │   │
│  │  │  └───────────┘    └───────────┘    └───────────┘              │   │   │
│  │  │                                          │                     │   │   │
│  │  │                                          ▼                     │   │   │
│  │  │                                   ┌───────────┐                │   │   │
│  │  │                                   │  Milvus   │                │   │   │
│  │  │                                   │ 向量存储   │                │   │   │
│  │  │                                   └───────────┘                │   │   │
│  │  │                                          │                     │   │   │
│  │  │  ┌───────────┐    ┌───────────┐         │                     │   │   │
│  │  │  │ 用户查询   │───▶│ 向量检索   │◀────────┘                     │   │   │
│  │  │  │           │    │           │                               │   │   │
│  │  │  └───────────┘    └───────────┘                               │   │   │
│  │  │                         │                                      │   │   │
│  │  │                         ▼                                      │   │   │
│  │  │  ┌───────────┐    ┌───────────┐    ┌───────────┐              │   │   │
│  │  │  │ 上下文构建 │───▶│ LLM生成   │───▶│ 结果返回   │              │   │   │
│  │  │  │           │    │           │    │           │              │   │   │
│  │  │  └───────────┘    └───────────┘    └───────────┘              │   │   │
│  │  │                                                                 │   │   │
│  │  └─────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         AI功能模块                                       │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐            │   │
│  │  │ AI对话    │  │ 方案生成   │  │ 智能搜索   │  │ 新闻推送   │            │   │
│  │  │           │  │           │  │           │  │           │            │   │
│  │  │ • 多轮对话 │  │ • 需求分析 │  │ • 语义搜索 │  │ • 行业识别 │            │   │
│  │  │ • 上下文   │  │ • 知识检索 │  │ • 向量检索 │  │ • 智能匹配 │            │   │
│  │  │ • 意图识别 │  │ • 内容生成 │  │ • 混合检索 │  │ • 个性推送 │            │   │
│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘            │   │
│  │                                                                         │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐            │   │
│  │  │ 文档处理   │  │ AI助手    │  │ 知识图谱   │  │ 数据分析   │            │   │
│  │  │           │  │           │  │           │  │           │            │   │
│  │  │ • OCR识别 │  │ • 任务建议 │  │ • 实体抽取 │  │ • 趋势分析 │            │   │
│  │  │ • 摘要生成 │  │ • 日程建议 │  │ • 关系抽取 │  │ • 预测分析 │            │   │
│  │  │ • 关键词   │  │ • 报告生成 │  │ • 图谱构建 │  │ • 异常检测 │            │   │
│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘            │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 AI成本控制

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              AI成本控制策略                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         多级缓存                                         │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  L1: 本地缓存 (Caffeine)                                                │   │
│  │      • 热点查询结果                                                      │   │
│  │      • 短期有效 (5分钟)                                                  │   │
│  │                                                                         │   │
│  │  L2: Redis缓存                                                          │   │
│  │      • 语义相似查询                                                      │   │
│  │      • 中期有效 (1小时)                                                  │   │
│  │                                                                         │   │
│  │  L3: 向量缓存 (Milvus)                                                  │   │
│  │      • 相似问题匹配                                                      │   │
│  │      • 长期有效                                                         │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         模型路由策略                                     │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │   │
│  │  │ 场景                │ 模型选择            │ 原因                │   │   │
│  │  ├─────────────────────────────────────────────────────────────────┤   │   │
│  │  │ 简单问答            │ GPT-3.5 / 通义千问  │ 成本低，速度快       │   │   │
│  │  │ 复杂推理            │ GPT-4 / Claude     │ 能力强，质量高       │   │   │
│  │  │ 方案生成            │ GPT-4 / Claude     │ 需要高质量输出       │   │   │
│  │  │ 代码生成            │ GPT-4 / Claude     │ 代码能力强          │   │   │
│  │  │ 中文场景            │ 通义千问 / 文心一言  │ 中文理解更好        │   │   │
│  │  │ 私有化部署          │ 本地模型            │ 数据安全            │   │   │
│  │  └─────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         配额管理                                         │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  租户级别配额：                                                          │   │
│  │  • 免费版：1000 tokens/天                                               │   │
│  │  • 专业版：100000 tokens/天                                             │   │
│  │  • 企业版：无限制                                                        │   │
│  │                                                                         │   │
│  │  用户级别配额：                                                          │   │
│  │  • 每用户每小时限制                                                      │   │
│  │  • 防止滥用                                                             │   │
│  │                                                                         │   │
│  │  预算告警：                                                              │   │
│  │  • 80%使用量告警                                                        │   │
│  │  • 100%使用量限制                                                       │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 八、安全架构设计

### 8.1 安全架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              安全架构                                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         网络安全                                         │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  • WAF (Web应用防火墙)                                                   │   │
│  │  • DDoS防护                                                             │   │
│  │  • SSL/TLS加密                                                          │   │
│  │  • 网络隔离 (VPC)                                                        │   │
│  │  • 安全组规则                                                            │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         认证授权                                         │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  认证方式：                                                              │   │
│  │  • JWT Token (Access Token + Refresh Token)                             │   │
│  │  • OAuth2.0 (第三方登录)                                                 │   │
│  │  • SSO (企业单点登录)                                                    │   │
│  │  • MFA (多因素认证)                                                      │   │
│  │                                                                         │   │
│  │  授权模型：                                                              │   │
│  │  • RBAC (基于角色的访问控制)                                              │   │
│  │  • ABAC (基于属性的访问控制)                                              │   │
│  │  • 数据权限 (行级、列级)                                                  │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         数据安全                                         │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  数据加密：                                                              │   │
│  │  • 传输加密 (TLS 1.3)                                                   │   │
│  │  • 存储加密 (AES-256)                                                   │   │
│  │  • 敏感字段加密                                                          │   │
│  │                                                                         │   │
│  │  数据脱敏：                                                              │   │
│  │  • 日志脱敏                                                             │   │
│  │  • 展示脱敏                                                             │   │
│  │  • 导出脱敏                                                             │   │
│  │                                                                         │   │
│  │  数据备份：                                                              │   │
│  │  • 定时备份                                                             │   │
│  │  • 异地备份                                                             │   │
│  │  • 备份加密                                                             │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         审计日志                                         │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  • 操作日志 (谁、什么时间、做了什么)                                       │   │
│  │  • 登录日志 (登录时间、IP、设备)                                          │   │
│  │  • 数据变更日志 (变更前后对比)                                            │   │
│  │  • API访问日志                                                          │   │
│  │  • 异常行为检测                                                          │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 九、部署架构设计

### 9.1 简化部署架构

采用传统的服务器部署方式，使用 Docker Compose 进行容器编排，Nginx 作为反向代理和负载均衡。

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              部署架构                                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         服务器规划                                       │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │   │
│  │  │ 服务器类型        │ 数量  │ 配置              │ 用途            │   │   │
│  │  ├─────────────────────────────────────────────────────────────────┤   │   │
│  │  │ 应用服务器        │ 2-4台 │ 8C16G             │ 微服务部署       │   │   │
│  │  │ 数据库服务器      │ 2台   │ 8C32G + SSD       │ MySQL主从       │   │   │
│  │  │ 缓存服务器        │ 2台   │ 4C16G             │ Redis集群       │   │   │
│  │  │ 中间件服务器      │ 2台   │ 8C16G             │ Kafka/ES/Nacos  │   │   │
│  │  │ 文件存储服务器    │ 1台   │ 4C8G + 大容量存储  │ MinIO           │   │   │
│  │  │ 监控服务器        │ 1台   │ 4C8G              │ Prometheus/ELK  │   │   │
│  │  └─────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         网络架构                                         │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │                          ┌─────────────┐                                │   │
│  │                          │   互联网     │                                │   │
│  │                          └──────┬──────┘                                │   │
│  │                                 │                                       │   │
│  │                          ┌──────▼──────┐                                │   │
│  │                          │  云防火墙   │                                │   │
│  │                          │  WAF/DDoS  │                                │   │
│  │                          └──────┬──────┘                                │   │
│  │                                 │                                       │   │
│  │                          ┌──────▼──────┐                                │   │
│  │                          │   Nginx     │                                │   │
│  │                          │  负载均衡   │                                │   │
│  │                          └──────┬──────┘                                │   │
│  │                                 │                                       │   │
│  │         ┌───────────────────────┼───────────────────────┐              │   │
│  │         │                       │                       │              │   │
│  │  ┌──────▼──────┐         ┌──────▼──────┐         ┌──────▼──────┐      │   │
│  │  │  应用服务器1  │         │  应用服务器2  │         │  应用服务器N  │      │   │
│  │  │  (微服务)    │         │  (微服务)    │         │  (微服务)    │      │   │
│  │  └──────┬──────┘         └──────┬──────┘         └──────┬──────┘      │   │
│  │         │                       │                       │              │   │
│  │         └───────────────────────┼───────────────────────┘              │   │
│  │                                 │                                       │   │
│  │                          ┌──────▼──────┐                                │   │
│  │                          │  内网交换机  │                                │   │
│  │                          └──────┬──────┘                                │   │
│  │                                 │                                       │   │
│  │    ┌────────────────────────────┼────────────────────────────┐         │   │
│  │    │                            │                            │         │   │
│  │  ┌─▼───────────┐         ┌──────▼──────┐         ┌──────────▼─┐       │   │
│  │  │  数据库集群   │         │  缓存集群    │         │  中间件集群  │       │   │
│  │  │ MySQL主从   │         │ Redis集群   │         │ Kafka/ES   │       │   │
│  │  └─────────────┘         └─────────────┘         └────────────┘       │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 9.2 Docker Compose 部署

```yaml
# docker-compose.yml 示例结构
version: '3.8'

services:
  # 网关服务
  mota-gateway:
    image: mota/gateway:latest
    ports:
      - "8080:8080"
    environment:
      - NACOS_SERVER=nacos:8848
    depends_on:
      - nacos
    deploy:
      replicas: 2

  # 用户服务
  mota-user-service:
    image: mota/user-service:latest
    environment:
      - NACOS_SERVER=nacos:8848
      - MYSQL_HOST=mysql
      - REDIS_HOST=redis
    depends_on:
      - mysql
      - redis
      - nacos

  # 项目服务
  mota-project-service:
    image: mota/project-service:latest
    environment:
      - NACOS_SERVER=nacos:8848
      - MYSQL_HOST=mysql
      - REDIS_HOST=redis
    depends_on:
      - mysql
      - redis
      - nacos

  # 任务服务
  mota-task-service:
    image: mota/task-service:latest
    environment:
      - NACOS_SERVER=nacos:8848
      - MYSQL_HOST=mysql
      - REDIS_HOST=redis
    depends_on:
      - mysql
      - redis
      - nacos

  # AI服务
  mota-ai-service:
    image: mota/ai-service:latest
    environment:
      - NACOS_SERVER=nacos:8848
      - MILVUS_HOST=milvus
    depends_on:
      - nacos
      - milvus

  # 基础设施
  mysql:
    image: mysql:8.0
    volumes:
      - mysql_data:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=xxx

  redis:
    image: redis:7
    volumes:
      - redis_data:/data

  nacos:
    image: nacos/nacos-server:v2.2.3
    environment:
      - MODE=standalone

  kafka:
    image: bitnami/kafka:3.5
    volumes:
      - kafka_data:/bitnami/kafka

  elasticsearch:
    image: elasticsearch:8.11.0
    volumes:
      - es_data:/usr/share/elasticsearch/data

  milvus:
    image: milvusdb/milvus:v2.3.0
    volumes:
      - milvus_data:/var/lib/milvus

volumes:
  mysql_data:
  redis_data:
  kafka_data:
  es_data:
  milvus_data:
```

### 9.3 Nginx 配置

```nginx
# nginx.conf 示例
upstream mota_gateway {
    server app-server-1:8080 weight=1;
    server app-server-2:8080 weight=1;
    keepalive 32;
}

upstream mota_websocket {
    server app-server-1:8081;
    server app-server-2:8081;
}

server {
    listen 80;
    server_name api.mota.com;
    
    # Let's Encrypt 验证路径
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
    
    # 其他请求重定向到 HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl http2;
    server_name api.mota.com;

    # SSL 证书配置 (Let's Encrypt 免费证书)
    ssl_certificate /etc/letsencrypt/live/api.mota.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.mota.com/privkey.pem;
    
    # SSL 安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;
    
    # HSTS (可选，建议生产环境启用)
    # add_header Strict-Transport-Security "max-age=63072000" always;

    # API 请求
    location /api/ {
        proxy_pass http://mota_gateway;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # WebSocket
    location /ws/ {
        proxy_pass http://mota_websocket;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_read_timeout 3600s;
    }

    # 静态资源
    location /static/ {
        alias /var/www/mota/static/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
```

### 9.4 SSL 证书方案

#### 9.4.1 方案对比

| 方案 | 费用 | 有效期 | 自动续期 | 适用场景 | 推荐度 |
|------|------|--------|---------|---------|--------|
| **Let's Encrypt (首选)** | 免费 | 90天 | 支持 | 所有场景 | ⭐⭐⭐⭐⭐ |
| 阿里云免费证书 | 免费 | 1年 | 不支持 | 单域名 | ⭐⭐⭐⭐ |
| 腾讯云免费证书 | 免费 | 1年 | 不支持 | 单域名 | ⭐⭐⭐⭐ |
| 付费DV证书 (备用) | ¥200-500/年 | 1年 | 不支持 | 需要品牌背书 | ⭐⭐⭐ |
| 付费OV/EV证书 (备用) | ¥2000+/年 | 1年 | 不支持 | 企业级、金融 | ⭐⭐ |

#### 9.4.2 首选方案：Let's Encrypt 免费证书

**优势：**
- 完全免费，无任何费用
- 支持通配符证书（*.mota.com）
- 自动续期，无需人工干预
- 被所有主流浏览器信任
- 社区活跃，文档完善

**安装 Certbot：**

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install certbot python3-certbot-nginx

# CentOS/RHEL
sudo yum install epel-release
sudo yum install certbot python3-certbot-nginx
```

**申请证书：**

```bash
# 方式1：自动配置 Nginx（推荐）
sudo certbot --nginx -d api.mota.com -d www.mota.com -d admin.mota.com

# 方式2：仅获取证书，手动配置
sudo certbot certonly --webroot -w /var/www/certbot \
    -d api.mota.com \
    -d www.mota.com \
    -d admin.mota.com

# 方式3：申请通配符证书（需要 DNS 验证）
sudo certbot certonly --manual --preferred-challenges dns \
    -d mota.com \
    -d *.mota.com
```

**自动续期配置：**

```bash
# 测试续期（不实际执行）
sudo certbot renew --dry-run

# 添加定时任务自动续期
sudo crontab -e
# 添加以下行（每天凌晨2点检查并续期）
0 2 * * * /usr/bin/certbot renew --quiet --post-hook "systemctl reload nginx"
```

**证书续期脚本：**

```bash
#!/bin/bash
# renew-cert.sh - SSL证书续期脚本

LOG_FILE="/var/log/certbot-renew.log"
DATE=$(date '+%Y-%m-%d %H:%M:%S')

echo "[$DATE] Starting certificate renewal check..." >> $LOG_FILE

# 执行续期
/usr/bin/certbot renew --quiet

# 检查续期结果
if [ $? -eq 0 ]; then
    echo "[$DATE] Certificate renewal check completed successfully" >> $LOG_FILE
    # 重载 Nginx 使新证书生效
    systemctl reload nginx
    echo "[$DATE] Nginx reloaded" >> $LOG_FILE
else
    echo "[$DATE] Certificate renewal failed!" >> $LOG_FILE
    # 发送告警通知
    curl -X POST "https://your-webhook-url" \
        -H "Content-Type: application/json" \
        -d '{"msg_type":"text","content":{"text":"SSL证书续期失败，请检查！"}}'
fi
```

#### 9.4.3 备用方案：付费证书

当以下情况时考虑使用付费证书：

1. **需要企业验证（OV证书）**：显示企业名称，增强用户信任
2. **需要扩展验证（EV证书）**：地址栏显示绿色企业名称
3. **合规要求**：某些行业（金融、医疗）可能要求特定类型证书
4. **技术支持**：需要7x24小时技术支持

**推荐的付费证书供应商：**

| 供应商 | DV证书价格 | OV证书价格 | 特点 |
|--------|-----------|-----------|------|
| 阿里云 | ¥200/年 | ¥2000/年 | 国内访问快，中文支持好 |
| 腾讯云 | ¥200/年 | ¥2000/年 | 与腾讯云服务集成好 |
| DigiCert | $200/年 | $500/年 | 国际知名，兼容性最好 |
| Sectigo | $100/年 | $300/年 | 性价比高 |

**付费证书配置示例：**

```nginx
server {
    listen 443 ssl http2;
    server_name api.mota.com;

    # 付费证书配置
    ssl_certificate /etc/nginx/ssl/mota.com.pem;
    ssl_certificate_key /etc/nginx/ssl/mota.com.key;
    
    # 证书链（如果有）
    # ssl_trusted_certificate /etc/nginx/ssl/mota.com.chain.pem;
    
    # 其他配置同上...
}
```

#### 9.4.4 证书监控

```bash
#!/bin/bash
# check-cert-expiry.sh - 证书过期检查脚本

DOMAIN="api.mota.com"
WARN_DAYS=30
ALERT_DAYS=7

# 获取证书过期时间
EXPIRY_DATE=$(echo | openssl s_client -servername $DOMAIN -connect $DOMAIN:443 2>/dev/null | openssl x509 -noout -enddate | cut -d= -f2)
EXPIRY_EPOCH=$(date -d "$EXPIRY_DATE" +%s)
CURRENT_EPOCH=$(date +%s)
DAYS_LEFT=$(( ($EXPIRY_EPOCH - $CURRENT_EPOCH) / 86400 ))

echo "Certificate for $DOMAIN expires in $DAYS_LEFT days"

if [ $DAYS_LEFT -lt $ALERT_DAYS ]; then
    echo "ALERT: Certificate expires in less than $ALERT_DAYS days!"
    # 发送紧急告警
elif [ $DAYS_LEFT -lt $WARN_DAYS ]; then
    echo "WARNING: Certificate expires in less than $WARN_DAYS days"
    # 发送预警通知
fi
```

### 9.5 部署脚本

```bash
#!/bin/bash
# deploy.sh - 服务部署脚本

# 配置
REGISTRY="registry.mota.com"
VERSION=${1:-latest}
SERVICES="gateway user-service project-service task-service ai-service"

# 拉取镜像
echo "Pulling images..."
for service in $SERVICES; do
    docker pull $REGISTRY/mota/$service:$VERSION
done

# 停止旧服务
echo "Stopping old services..."
docker-compose down

# 启动新服务
echo "Starting new services..."
docker-compose up -d

# 健康检查
echo "Health checking..."
sleep 30
for service in $SERVICES; do
    health=$(curl -s http://localhost:8080/actuator/health | jq -r '.status')
    if [ "$health" != "UP" ]; then
        echo "Service $service is not healthy!"
        exit 1
    fi
done

echo "Deployment completed successfully!"
```

### 9.5 数据库备份策略

```bash
#!/bin/bash
# backup.sh - 数据库备份脚本

# 配置
BACKUP_DIR="/data/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=7

# 全量备份
mysqldump -h mysql-master -u root -p$MYSQL_PASSWORD \
    --all-databases \
    --single-transaction \
    --routines \
    --triggers \
    > $BACKUP_DIR/full_backup_$DATE.sql

# 压缩
gzip $BACKUP_DIR/full_backup_$DATE.sql

# 上传到远程存储
aws s3 cp $BACKUP_DIR/full_backup_$DATE.sql.gz \
    s3://mota-backup/mysql/

# 清理旧备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +$RETENTION_DAYS -delete

echo "Backup completed: full_backup_$DATE.sql.gz"
```

---

## 十、监控告警设计

### 10.1 监控体系

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              监控体系                                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         指标监控 (Metrics)                               │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │   │
│  │  │ 层级          │ 监控指标                                        │   │   │
│  │  ├─────────────────────────────────────────────────────────────────┤   │   │
│  │  │ 基础设施      │ CPU、内存、磁盘、网络                            │   │   │
│  │  │ 容器         │ 容器状态、资源使用、重启次数                       │   │   │
│  │  │ 中间件       │ Redis命中率、Kafka延迟、ES查询耗时                │   │   │
│  │  │ 应用         │ QPS、响应时间、错误率、JVM指标                    │   │   │
│  │  │ 业务         │ 用户活跃、任务完成率、AI调用量                    │   │   │
│  │  └─────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                         │   │
│  │  技术栈：Prometheus + Grafana                                          │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         日志监控 (Logging)                               │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                │   │
│  │  │  Filebeat   │───▶│   Kafka     │───▶│ Logstash    │                │   │
│  │  │  (采集)     │    │  (缓冲)     │    │  (处理)     │                │   │
│  │  └─────────────┘    └─────────────┘    └─────────────┘                │   │
│  │                                              │                         │   │
│  │                                              ▼                         │   │
│  │                     ┌─────────────┐    ┌─────────────┐                │   │
│  │                     │   Kibana    │◀───│Elasticsearch│                │   │
│  │                     │  (可视化)   │    │  (存储)     │                │   │
│  │                     └─────────────┘    └─────────────┘                │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         链路追踪 (Tracing)                               │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  技术栈：SkyWalking                                                     │   │
│  │                                                                         │   │
│  │  功能：                                                                 │   │
│  │  • 分布式链路追踪                                                       │   │
│  │  • 服务拓扑图                                                           │   │
│  │  • 性能分析                                                             │   │
│  │  • 告警集成                                                             │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         告警规则                                         │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │   │
│  │  │ 级别    │ 条件                        │ 通知方式              │   │   │
│  │  ├─────────────────────────────────────────────────────────────────┤   │   │
│  │  │ P0紧急  │ 服务不可用、数据库宕机        │ 电话+短信+钉钉        │   │   │
│  │  │ P1严重  │ 错误率>5%、响应时间>3s       │ 短信+钉钉             │   │   │
│  │  │ P2警告  │ CPU>80%、内存>85%           │ 钉钉+邮件             │   │   │
│  │  │ P3提示  │ 磁盘>70%、连接数>80%        │ 邮件                  │   │   │
│  │  └─────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 十一、实施路线图

### 11.1 阶段规划

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              实施路线图                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         第一阶段：基础重构 (2个月)                        │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  目标：完成核心服务拆分和基础设施搭建                                      │   │
│  │                                                                         │   │
│  │  任务：                                                                  │   │
│  │  ☐ 搭建Docker Compose部署环境                                           │   │
│  │  ☐ 部署基础中间件 (Nacos, Redis, Kafka, ES)                             │   │
│  │  ☐ 拆分mota-project-service为project-svc和task-svc                      │   │
│  │  ☐ 整合AI服务到mota-ai-service                                          │   │
│  │  ☐ 整合知识服务到mota-knowledge-service                                  │   │
│  │  ☐ 配置Nginx负载均衡                                                    │   │
│  │  ☐ 编写部署脚本和运维文档                                                │   │
│  │                                                                         │   │
│  │  交付物：                                                                │   │
│  │  • 重构后的微服务架构                                                    │   │
│  │  • 基础设施环境                                                          │   │
│  │  • 部署脚本和文档                                                        │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         第二阶段：多租户支持 (1.5个月)                    │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  目标：实现SaaS多租户架构                                                 │   │
│  │                                                                         │   │
│  │  任务：                                                                  │   │
│  │  ☐ 开发mota-tenant-service                                              │   │
│  │  ☐ 实现多租户数据隔离                                                    │   │
│  │  ☐ 实现租户配额管理                                                      │   │
│  │  ☐ 实现计费计量功能                                                      │   │
│  │  ☐ 改造现有服务支持多租户                                                │   │
│  │                                                                         │   │
│  │  交付物：                                                                │   │
│  │  • 多租户架构                                                           │   │
│  │  • 租户管理功能                                                          │   │
│  │  • 计费系统                                                             │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         第三阶段：移动App开发 (2个月)                     │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  目标：发布iOS和Android移动应用                                          │   │
│  │                                                                         │   │
│  │  任务：                                                                  │   │
│  │  ☐ 搭建React Native + Expo项目                                          │   │
│  │  ☐ 开发mota-app-bff                                                     │   │
│  │  ☐ 实现核心功能 (任务、通知、日程)                                        │   │
│  │  ☐ 实现离线支持                                                          │   │
│  │  ☐ 实现推送通知                                                          │   │
│  │  ☐ 应用商店上架                                                          │   │
│  │                                                                         │   │
│  │  交付物：                                                                │   │
│  │  • iOS App                                                              │   │
│  │  • Android App                                                          │   │
│  │  • App BFF服务                                                          │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         第四阶段：运营后台开发 (1.5个月)                   │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  目标：发布运营管理后台                                                   │   │
│  │                                                                         │   │
│  │  任务：                                                                  │   │
│  │  ☐ 搭建Ant Design Pro项目                                               │   │
│  │  ☐ 开发mota-admin-bff                                                   │   │
│  │  ☐ 实现租户管理功能                                                      │   │
│  │  ☐ 实现用户管理功能                                                      │   │
│  │  ☐ 实现数据统计功能                                                      │   │
│  │  ☐ 实现系统配置功能                                                      │   │
│  │                                                                         │   │
│  │  交付物：                                                                │   │
│  │  • 运营管理后台                                                          │   │
│  │  • Admin BFF服务                                                        │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         第五阶段：Web端升级 (1.5个月)                     │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  目标：升级用户Web端到Next.js                                            │   │
│  │                                                                         │   │
│  │  任务：                                                                  │   │
│  │  ☐ 迁移到Next.js 14                                                     │   │
│  │  ☐ 实现SSR/SSG优化                                                      │   │
│  │  ☐ 开发mota-user-bff                                                    │   │
│  │  ☐ 优化性能和SEO                                                        │   │
│  │  ☐ 实现实时协作功能                                                      │   │
│  │                                                                         │   │
│  │  交付物：                                                                │   │
│  │  • 升级后的Web端                                                        │   │
│  │  • User BFF服务                                                         │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         第六阶段：监控完善 (1个月)                        │   │
│  ├─────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                         │   │
│  │  目标：完善监控告警体系                                                   │   │
│  │                                                                         │   │
│  │  任务：                                                                  │   │
│  │  ☐ 部署Prometheus + Grafana                                             │   │
│  │  ☐ 部署ELK日志系统                                                      │   │
│  │  ☐ 部署SkyWalking链路追踪                                               │   │
│  │  ☐ 配置告警规则                                                          │   │
│  │  ☐ 建立SLA监控                                                          │   │
│  │                                                                         │   │
│  │  交付物：                                                                │   │
│  │  • 完整的监控体系                                                        │   │
│  │  • 告警系统                                                             │   │
│  │  • 运维文档                                                             │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 11.2 里程碑

| 阶段 | 时间 | 里程碑 | 关键交付物 |
|------|------|--------|-----------|
| 第一阶段 | M1-M2 | 基础重构完成 | 微服务架构、部署环境 |
| 第二阶段 | M3-M4 | 多租户上线 | SaaS架构、计费系统 |
| 第三阶段 | M5-M6 | App发布 | iOS/Android App |
| 第四阶段 | M7-M8 | 运营后台上线 | 管理后台 |
| 第五阶段 | M9-M10 | Web端升级 | Next.js Web端 |
| 第六阶段 | M11 | 监控完善 | 监控告警体系 |

---

## 十二、风险与应对

### 12.1 技术风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| 服务拆分导致数据不一致 | 高 | 中 | 使用Seata分布式事务，设计补偿机制 |
| 微服务通信延迟 | 中 | 中 | 优化服务调用链，使用缓存，异步处理 |
| AI服务成本超支 | 高 | 中 | 多级缓存，模型路由，配额管理 |
| 多租户数据泄露 | 高 | 低 | 严格的数据隔离，安全审计 |
| 移动端兼容性问题 | 中 | 中 | 充分测试，渐进式发布 |

### 12.2 项目风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| 开发周期延长 | 高 | 中 | 敏捷开发，MVP优先，持续交付 |
| 技术栈学习成本 | 中 | 中 | 技术培训，文档完善，代码评审 |
| 人员变动 | 中 | 低 | 知识共享，文档沉淀，交叉培训 |

---

## 十三、总结

本技术架构方案针对摩塔Mota平台的现状和未来发展需求，提出了全面的重构方案：

### 核心改进

1. **服务拆分**：将臃肿的project-service拆分为多个职责单一的微服务
2. **多端支持**：新增移动App和运营管理后台，实现多端覆盖
3. **多租户架构**：支持SaaS模式，实现租户隔离和计费
4. **AI架构优化**：统一AI服务，优化成本控制
5. **BFF层设计**：针对不同端提供定制化的API聚合
6. **简化部署**：使用Docker Compose + Nginx，降低运维复杂度

### 预期收益

- **可扩展性**：支持业务快速增长
- **可维护性**：服务职责清晰，易于维护
- **高可用性**：多实例部署，负载均衡
- **多端覆盖**：Web、App、管理后台全覆盖
- **商业化支持**：多租户、计费、配额管理
- **运维简单**：Docker Compose部署，脚本化运维

### 实施建议

1. **渐进式重构**：分阶段实施，降低风险
2. **MVP优先**：先实现核心功能，快速验证
3. **持续交付**：小步快跑，持续迭代
4. **技术债务管理**：定期清理技术债务

---

*文档版本: v1.1*
*创建日期: 2026-01-07*
*更新日期: 2026-01-07*
*作者: Mota技术团队*