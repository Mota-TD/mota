# 摩塔后端环境搭建指南

本文档详细介绍如何搭建摩塔（Mota）后端服务的开发环境。

## 目录

- [环境要求](#环境要求)
- [使用 Docker Desktop + IDEA 启动](#使用-docker-desktop--idea-启动)
- [常见问题](#常见问题)

---

## 环境要求

| 组件 | 版本要求 | 用途 |
|------|---------|------|
| Docker Desktop | 最新版 | 运行基础设施服务 |
| IntelliJ IDEA | 最新版 | Java 开发 IDE |
| JDK | 21+ | Java 运行环境 |

---

## 使用 Docker Desktop + IDEA 启动

这是最简单的开发环境搭建方式，适合大多数开发者。

### 第一步：启动 Docker 容器

打开终端，进入 docker 目录并启动基础设施服务：

```bash
cd mota-service/docker
docker-compose up -d
```

这将启动以下服务：

| 服务 | 容器名 | 端口 | 用途 |
|------|--------|------|------|
| MySQL | mota-mysql | 3306 | 数据库 |
| Redis | mota-redis | 6379 | 缓存 |
| Nacos | mota-nacos | 8848 | 服务注册与配置中心 |

**默认账号密码配置：**

| 服务 | 用户名 | 密码 | 说明 |
|------|--------|------|------|
| MySQL | root | root123 | 管理员账号 |
| MySQL | mota | mota123 | 应用账号（推荐使用） |
| Redis | - | - | 无密码 |
| Nacos | nacos | nacos | 控制台登录 |
| 系统管理员 | admin | password | 摩塔系统默认管理员 |

### 第二步：验证容器状态

```bash
docker ps
```

确认三个容器都处于运行状态（STATUS 显示 Up）。

也可以访问 Nacos 控制台验证服务是否正常：
- 地址：http://localhost:8848/nacos
- 用户名：`nacos`
- 密码：`nacos`

### 第三步：在 IDEA 中打开项目

1. 打开 IntelliJ IDEA
2. 选择 **File → Open**
3. 选择 `mota-service` 目录
4. 等待 Maven 自动导入依赖（首次可能需要几分钟）

### 第四步：编译项目

在 IDEA 的 Terminal 中执行：

```bash
mvn clean install -DskipTests
```

或者使用 IDEA 的 Maven 面板：
1. 打开右侧 Maven 面板
2. 展开 mota-service
3. 双击 **Lifecycle → install**

### 第五步：启动服务

按以下顺序启动各服务（右键 Application 类 → **Run 'xxxApplication'**）：

| 启动顺序 | 服务 | 启动类位置 | 端口 |
|---------|------|-----------|------|
| 1 | 网关 | `mota-gateway/src/main/java/com/mota/gateway/GatewayApplication.java` | 8080 |
| 2 | 用户服务 | `mota-user-service/src/main/java/com/mota/user/UserApplication.java` | 8082 |
| 3 | 项目服务 | `mota-project-service/src/main/java/com/mota/project/ProjectApplication.java` | 8083 |
| 4 | 任务服务 | `mota-issue-service/src/main/java/com/mota/issue/IssueApplication.java` | 8084 |

**IDEA 启动服务的方法：**
1. 在 Project 面板中找到对应的 Application 类
2. 右键点击该类
3. 选择 **Run 'xxxApplication'**

或者使用快捷键：
- 打开 Application 类文件
- 按 `Ctrl+Shift+F10`（Windows）或 `Ctrl+Shift+R`（macOS）

### 第六步：验证服务

服务启动成功后，可以通过以下地址验证：

| 验证项 | 地址 |
|--------|------|
| 网关 API | http://localhost:8080 |
| API 文档 | http://localhost:8080/doc.html |
| Nacos 控制台 | http://localhost:8848/nacos |
| 用户服务 | http://localhost:8082 |
| 项目服务 | http://localhost:8083 |
| 任务服务 | http://localhost:8084 |

### 停止服务

**停止 Java 服务：**
- 在 IDEA 中点击红色停止按钮

**停止 Docker 容器：**

```bash
cd mota-service/docker
docker-compose down
```

如需保留数据，使用 `docker-compose stop`；如需清除数据，使用 `docker-compose down -v`。

---

## 常见问题

### 1. 端口被占用

**问题**：启动时提示 "Port xxxx was already in use"

**解决方案**：

```bash
# Windows - 查找占用端口的进程
netstat -ano | findstr :8081

# 终止进程
taskkill /F /PID <进程ID>

# Linux/macOS
lsof -i :8081
kill -9 <进程ID>
```

### 2. 数据库连接失败

**问题**：无法连接到 MySQL

**检查项**：
- Docker 容器是否启动（`docker ps`）
- 端口是否正确（默认 3306）
- 用户名密码是否正确（默认 mota/mota123，root 密码为 root123）

### 3. Nacos 连接失败

**问题**：服务无法注册到 Nacos

**检查项**：
- Nacos 容器是否启动（访问 http://localhost:8848/nacos）
- 防火墙是否阻止了 8848 和 9848 端口

### 4. Maven 下载依赖慢

**解决方案**：配置阿里云镜像

编辑 `~/.m2/settings.xml`（Windows: `C:\Users\<用户名>\.m2\settings.xml`）：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<settings>
  <mirrors>
    <mirror>
      <id>aliyun</id>
      <name>Aliyun Maven Mirror</name>
      <url>https://maven.aliyun.com/repository/public</url>
      <mirrorOf>central</mirrorOf>
    </mirror>
  </mirrors>
</settings>
```

### 5. JDK 版本不对

**问题**：提示需要 Java 21

**解决方案**：
- 确认安装了 JDK 21
- 在 IDEA 中设置 Project SDK 为 JDK 21
- 运行 `java -version` 确认版本

---

## 联系支持

如有问题，请提交 Issue 或联系开发团队。