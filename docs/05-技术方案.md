# 摩塔 Mota - 技术方案

> 版本：2.0  
> 日期：2025-12-27  
> 文档类型：产品设计稿

---

## 1. 技术架构总览

### 1.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              系统架构总览                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          客户端层                                    │   │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐           │   │
│  │  │   Web端       │  │   移动端      │  │   桌面端      │           │   │
│  │  │  React SPA    │  │  React Native │  │   Electron    │           │   │
│  │  └───────────────┘  └───────────────┘  └───────────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          网关层                                      │   │
│  │  ┌───────────────────────────────────────────────────────────────┐ │   │
│  │  │  API Gateway (Spring Cloud Gateway)                           │ │   │
│  │  │  • 路由转发 • 负载均衡 • 限流熔断 • 认证鉴权                  │ │   │
│  │  └───────────────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          服务层                                      │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │   │
│  │  │ 项目    │ │ 用户    │ │ AI      │ │ 知识    │ │ 通知    │       │   │
│  │  │ 服务    │ │ 服务    │ │ 服务    │ │ 服务    │ │ 服务    │       │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘       │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐                               │   │
│  │  │ 日历    │ │ 报表    │ │ 文件    │                               │   │
│  │  │ 服务    │ │ 服务    │ │ 服务    │                               │   │
│  │  └─────────┘ └─────────┘ └─────────┘                               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          数据层                                      │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │   │
│  │  │  MySQL    │ │  Redis    │ │  Milvus   │ │  Neo4j    │           │   │
│  │  │  主数据库 │ │  缓存     │ │  向量库   │ │  图数据库 │           │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐                         │   │
│  │  │  MinIO    │ │  ES       │ │  Kafka    │                         │   │
│  │  │  对象存储 │ │  搜索引擎 │ │  消息队列 │                         │   │
│  │  └───────────┘ └───────────┘ └───────────┘                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 技术栈概览

| 层级 | 技术选型 | 版本 | 说明 |
|------|----------|------|------|
| 前端框架 | React | 18.x | 主框架 |
| 前端语言 | TypeScript | 5.x | 类型安全 |
| UI组件库 | Ant Design | 5.x | 企业级组件 |
| 状态管理 | Zustand | 4.x | 轻量状态管理 |
| 构建工具 | Vite | 5.x | 快速构建 |
| 后端框架 | Spring Boot | 3.x | 主框架 |
| 后端语言 | Java | 17 | LTS版本 |
| ORM框架 | MyBatis-Plus | 3.x | 数据访问 |
| 主数据库 | MySQL | 8.x | 关系型数据库 |
| 缓存 | Redis | 7.x | 分布式缓存 |
| 向量数据库 | Milvus | 2.x | AI向量存储 |
| 图数据库 | Neo4j | 5.x | 知识图谱 |
| 搜索引擎 | Elasticsearch | 8.x | 全文搜索 |
| 消息队列 | Kafka | 3.x | 异步消息 |
| 对象存储 | MinIO | - | 文件存储 |
| AI大模型 | 豆包(Doubao) | - | 默认AI模型，火山引擎 |

---

## 2. 前端技术方案

### 2.1 项目结构

```
mota-web/
├── public/                    # 静态资源
├── src/
│   ├── components/           # 公共组件
│   │   ├── AIProgressPrediction/
│   │   ├── KanbanBoard/
│   │   ├── MilestoneTimeline/
│   │   └── ...
│   ├── pages/                # 页面组件
│   │   ├── auth/            # 认证页面
│   │   ├── dashboard/       # 工作台
│   │   ├── projects/        # 项目管理
│   │   ├── ai/              # AI模块
│   │   └── ...
│   ├── services/            # API服务
│   │   ├── api/             # API定义
│   │   └── request.ts       # 请求封装
│   ├── store/               # 状态管理
│   │   ├── auth.ts          # 认证状态
│   │   └── theme.ts         # 主题状态
│   ├── styles/              # 全局样式
│   ├── utils/               # 工具函数
│   ├── router/              # 路由配置
│   ├── App.tsx              # 根组件
│   └── main.tsx             # 入口文件
├── package.json
├── tsconfig.json
└── vite.config.ts
```

### 2.2 核心技术实现

#### 2.2.1 状态管理

```typescript
// store/auth.ts
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface AuthState {
  user: User | null;
  token: string | null;
  isAuthenticated: boolean;
  login: (credentials: LoginCredentials) => Promise<void>;
  logout: () => void;
  refreshToken: () => Promise<void>;
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set, get) => ({
      user: null,
      token: null,
      isAuthenticated: false,
      
      login: async (credentials) => {
        const response = await authApi.login(credentials);
        set({
          user: response.user,
          token: response.token,
          isAuthenticated: true,
        });
      },
      
      logout: () => {
        set({
          user: null,
          token: null,
          isAuthenticated: false,
        });
      },
      
      refreshToken: async () => {
        const response = await authApi.refresh();
        set({ token: response.token });
      },
    }),
    {
      name: 'auth-storage',
      partialize: (state) => ({ token: state.token }),
    }
  )
);
```

#### 2.2.2 API请求封装

```typescript
// services/request.ts
import axios, { AxiosInstance, AxiosRequestConfig } from 'axios';
import { useAuthStore } from '@/store/auth';

const request: AxiosInstance = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL,
  timeout: 30000,
  headers: {
    'Content-Type': 'application/json',
  },
});

// 请求拦截器
request.interceptors.request.use(
  (config) => {
    const token = useAuthStore.getState().token;
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => Promise.reject(error)
);

// 响应拦截器
request.interceptors.response.use(
  (response) => response.data,
  async (error) => {
    if (error.response?.status === 401) {
      // Token过期，尝试刷新
      try {
        await useAuthStore.getState().refreshToken();
        return request(error.config);
      } catch {
        useAuthStore.getState().logout();
        window.location.href = '/login';
      }
    }
    return Promise.reject(error);
  }
);

export default request;
```

#### 2.2.3 路由配置

```typescript
// router/index.tsx
import { createBrowserRouter, Navigate } from 'react-router-dom';
import { lazy, Suspense } from 'react';

const Dashboard = lazy(() => import('@/pages/dashboard'));
const Projects = lazy(() => import('@/pages/projects'));
const AIAssistant = lazy(() => import('@/pages/ai/assistant'));

const ProtectedRoute = ({ children }: { children: React.ReactNode }) => {
  const { isAuthenticated } = useAuthStore();
  if (!isAuthenticated) {
    return <Navigate to="/login" replace />;
  }
  return <>{children}</>;
};

export const router = createBrowserRouter([
  {
    path: '/',
    element: <MainLayout />,
    children: [
      {
        path: 'dashboard',
        element: (
          <ProtectedRoute>
            <Suspense fallback={<Loading />}>
              <Dashboard />
            </Suspense>
          </ProtectedRoute>
        ),
      },
      {
        path: 'projects',
        element: (
          <ProtectedRoute>
            <Suspense fallback={<Loading />}>
              <Projects />
            </Suspense>
          </ProtectedRoute>
        ),
      },
      // ... 更多路由
    ],
  },
]);
```

### 2.3 性能优化策略

| 优化项 | 实现方式 | 预期效果 |
|--------|----------|----------|
| 代码分割 | React.lazy + Suspense | 首屏加载减少50% |
| 路由懒加载 | 动态import | 按需加载页面 |
| 组件缓存 | React.memo + useMemo | 减少重渲染 |
| 虚拟列表 | react-window | 大数据列表流畅 |
| 图片优化 | WebP + 懒加载 | 图片加载提速 |
| 请求缓存 | SWR / React Query | 减少重复请求 |

---

## 3. 后端技术方案

### 3.1 项目结构

```
mota-service/
├── mota-common/              # 公共模块
│   ├── common-core/         # 核心工具
│   ├── common-security/     # 安全模块
│   └── common-redis/        # Redis封装
├── mota-gateway/             # API网关
├── mota-project-service/     # 项目服务
│   ├── src/main/java/
│   │   └── com/mota/project/
│   │       ├── controller/  # 控制器
│   │       ├── service/     # 业务逻辑
│   │       ├── mapper/      # 数据访问
│   │       ├── entity/      # 实体类
│   │       ├── dto/         # 数据传输对象
│   │       └── config/      # 配置类
│   └── src/main/resources/
│       ├── mapper/          # MyBatis映射
│       └── application.yml  # 配置文件
├── mota-user-service/        # 用户服务
├── mota-ai-service/          # AI服务
├── mota-knowledge-service/   # 知识服务
├── mota-notify-service/      # 通知服务
└── mota-calendar-service/    # 日历服务
```

### 3.2 核心技术实现

#### 3.2.1 统一响应封装

```java
// common-core/Result.java
@Data
@AllArgsConstructor
@NoArgsConstructor
public class Result<T> {
    private int code;
    private String message;
    private T data;
    private long timestamp;
    
    public static <T> Result<T> success(T data) {
        return new Result<>(200, "success", data, System.currentTimeMillis());
    }
    
    public static <T> Result<T> error(int code, String message) {
        return new Result<>(code, message, null, System.currentTimeMillis());
    }
    
    public static <T> Result<T> error(ErrorCode errorCode) {
        return new Result<>(errorCode.getCode(), errorCode.getMessage(), 
                           null, System.currentTimeMillis());
    }
}
```

#### 3.2.2 全局异常处理

```java
// common-core/GlobalExceptionHandler.java
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public Result<Void> handleBusinessException(BusinessException e) {
        log.warn("业务异常: {}", e.getMessage());
        return Result.error(e.getCode(), e.getMessage());
    }
    
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public Result<Void> handleValidationException(MethodArgumentNotValidException e) {
        String message = e.getBindingResult().getFieldErrors().stream()
            .map(FieldError::getDefaultMessage)
            .collect(Collectors.joining(", "));
        return Result.error(400, message);
    }
    
    @ExceptionHandler(Exception.class)
    public Result<Void> handleException(Exception e) {
        log.error("系统异常", e);
        return Result.error(500, "系统繁忙，请稍后重试");
    }
}
```

#### 3.2.3 JWT认证

```java
// common-security/JwtTokenProvider.java
@Component
public class JwtTokenProvider {
    
    @Value("${jwt.secret}")
    private String secret;
    
    @Value("${jwt.expiration}")
    private long expiration;
    
    public String generateToken(UserDetails userDetails) {
        Map<String, Object> claims = new HashMap<>();
        claims.put("roles", userDetails.getAuthorities().stream()
            .map(GrantedAuthority::getAuthority)
            .collect(Collectors.toList()));
        
        return Jwts.builder()
            .setClaims(claims)
            .setSubject(userDetails.getUsername())
            .setIssuedAt(new Date())
            .setExpiration(new Date(System.currentTimeMillis() + expiration))
            .signWith(SignatureAlgorithm.HS512, secret)
            .compact();
    }
    
    public boolean validateToken(String token) {
        try {
            Jwts.parser().setSigningKey(secret).parseClaimsJws(token);
            return true;
        } catch (JwtException e) {
            return false;
        }
    }
    
    public String getUsernameFromToken(String token) {
        Claims claims = Jwts.parser()
            .setSigningKey(secret)
            .parseClaimsJws(token)
            .getBody();
        return claims.getSubject();
    }
}
```

#### 3.2.4 分布式缓存

```java
// common-redis/CacheService.java
@Service
public class CacheService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    public <T> void set(String key, T value, long timeout, TimeUnit unit) {
        redisTemplate.opsForValue().set(key, value, timeout, unit);
    }
    
    @SuppressWarnings("unchecked")
    public <T> T get(String key, Class<T> clazz) {
        Object value = redisTemplate.opsForValue().get(key);
        return value != null ? (T) value : null;
    }
    
    public void delete(String key) {
        redisTemplate.delete(key);
    }
    
    public boolean hasKey(String key) {
        return Boolean.TRUE.equals(redisTemplate.hasKey(key));
    }
    
    // 分布式锁
    public boolean tryLock(String key, long timeout, TimeUnit unit) {
        return Boolean.TRUE.equals(
            redisTemplate.opsForValue().setIfAbsent(key, "1", timeout, unit)
        );
    }
    
    public void unlock(String key) {
        redisTemplate.delete(key);
    }
}
```

---

## 4. AI技术方案

### 4.1 AI架构设计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              AI架构设计                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          AI应用层                                    │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │   │
│  │  │ AI助手    │ │ 方案生成  │ │ 任务分解  │ │ 智能分工  │           │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │   │
│  │  │ 进度预测  │ │ 风险预警  │ │ 智能搜索  │ │ 报表洞察  │           │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          AI能力层                                    │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                      RAG引擎                                 │   │   │
│  │  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │   │   │
│  │  │  │ 文档解析│->│ 向量化  │->│ 检索    │->│ 生成    │        │   │   │
│  │  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘        │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                      Prompt工程                              │   │   │
│  │  │  • 系统提示词 • 上下文管理 • 输出格式化 • 安全过滤          │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          模型层                                      │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │   │
│  │  │  豆包     │ │  GPT-4    │ │  Claude   │ │ 通义千问  │           │   │
│  │  │ 火山引擎  │ │  OpenAI   │ │ Anthropic │ │  阿里云   │           │   │
│  │  │ (默认)    │ │           │ │           │ │           │           │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          数据层                                      │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐                         │   │
│  │  │  Milvus   │ │  Neo4j    │ │  MySQL    │                         │   │
│  │  │  向量库   │ │  图数据库 │ │  元数据   │                         │   │
│  │  └───────────┘ └───────────┘ └───────────┘                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 RAG实现方案

```python
# ai-service/rag_engine.py
from langchain.embeddings import OpenAIEmbeddings
from langchain.vectorstores import Milvus
from langchain.text_splitter import RecursiveCharacterTextSplitter
from langchain.chains import RetrievalQA
from langchain.llms import OpenAI

class RAGEngine:
    def __init__(self):
        self.embeddings = OpenAIEmbeddings()
        self.vector_store = Milvus(
            embedding_function=self.embeddings,
            connection_args={"host": "localhost", "port": "19530"},
            collection_name="knowledge_base"
        )
        self.text_splitter = RecursiveCharacterTextSplitter(
            chunk_size=1000,
            chunk_overlap=200
        )
        self.llm = OpenAI(temperature=0.7)
    
    def index_document(self, document: str, metadata: dict):
        """索引文档"""
        chunks = self.text_splitter.split_text(document)
        self.vector_store.add_texts(
            texts=chunks,
            metadatas=[metadata] * len(chunks)
        )
    
    def query(self, question: str, top_k: int = 5) -> str:
        """查询并生成回答"""
        # 检索相关文档
        docs = self.vector_store.similarity_search(question, k=top_k)
        
        # 构建上下文
        context = "\n\n".join([doc.page_content for doc in docs])
        
        # 生成回答
        qa_chain = RetrievalQA.from_chain_type(
            llm=self.llm,
            chain_type="stuff",
            retriever=self.vector_store.as_retriever()
        )
        
        return qa_chain.run(question)
    
    def generate_proposal(self, requirements: str, template: str) -> str:
        """生成方案"""
        # 检索相关历史方案
        similar_proposals = self.vector_store.similarity_search(
            requirements, 
            k=3,
            filter={"type": "proposal"}
        )
        
        # 构建提示词
        prompt = f"""
        基于以下需求和参考方案，生成一份专业的方案文档。
        
        需求描述：
        {requirements}
        
        参考方案：
        {[doc.page_content for doc in similar_proposals]}
        
        模板格式：
        {template}
        
        请生成完整的方案文档：
        """
        
        return self.llm(prompt)
```

### 4.3 多模型适配

```java
// ai-service/MultiModelAdapter.java
@Service
public class MultiModelAdapter {
    
    private final Map<String, AIModelClient> clients = new HashMap<>();
    
    @PostConstruct
    public void init() {
        // 豆包模型作为默认首选
        clients.put("doubao-pro-32k", new DoubaoClient("doubao-pro-32k"));
        clients.put("doubao-pro-128k", new DoubaoClient("doubao-pro-128k"));
        clients.put("doubao-lite-32k", new DoubaoClient("doubao-lite-32k"));
        clients.put("doubao-lite-128k", new DoubaoClient("doubao-lite-128k"));
        // 其他模型作为备选
        clients.put("gpt-4", new OpenAIClient());
        clients.put("claude", new ClaudeClient());
        clients.put("qwen", new QwenClient());
        clients.put("ernie", new ErnieClient());
    }
    
    // 默认使用豆包模型
    private String defaultModel = "doubao-pro-32k";
    
    public String chat(String model, List<Message> messages) {
        AIModelClient client = clients.get(model);
        if (client == null) {
            throw new BusinessException("不支持的模型: " + model);
        }
        return client.chat(messages);
    }
    
    public String chatWithDefault(List<Message> messages) {
        return chat(defaultModel, messages);
    }
    
    public CompletableFuture<String> chatAsync(String model, List<Message> messages) {
        return CompletableFuture.supplyAsync(() -> chat(model, messages));
    }
    
    public Stream<String> chatStream(String model, List<Message> messages) {
        AIModelClient client = clients.get(model);
        return client.chatStream(messages);
    }
}

// 模型客户端接口
public interface AIModelClient {
    String chat(List<Message> messages);
    Stream<String> chatStream(List<Message> messages);
}

// 豆包模型实现（默认首选）
@Component
public class DoubaoClient implements AIModelClient {
    
    private static final String API_ENDPOINT = "https://ark.cn-beijing.volces.com/api/v3/chat/completions";
    
    @Value("${doubao.api-key}")
    private String apiKey;
    
    private String model;
    
    public DoubaoClient(String model) {
        this.model = model;
    }
    
    @Override
    public String chat(List<Message> messages) {
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.setBearerAuth(apiKey);
        
        Map<String, Object> requestBody = new HashMap<>();
        requestBody.put("model", model);
        requestBody.put("messages", convertMessages(messages));
        
        RestTemplate restTemplate = new RestTemplate();
        HttpEntity<Map<String, Object>> entity = new HttpEntity<>(requestBody, headers);
        
        ResponseEntity<Map> response = restTemplate.postForEntity(
            API_ENDPOINT, entity, Map.class
        );
        
        Map<String, Object> body = response.getBody();
        List<Map<String, Object>> choices = (List<Map<String, Object>>) body.get("choices");
        Map<String, Object> message = (Map<String, Object>) choices.get(0).get("message");
        return (String) message.get("content");
    }
    
    @Override
    public Stream<String> chatStream(List<Message> messages) {
        // 流式输出实现
    }
    
    private List<Map<String, String>> convertMessages(List<Message> messages) {
        return messages.stream()
            .map(m -> Map.of("role", m.getRole(), "content", m.getContent()))
            .collect(Collectors.toList());
    }
}

// OpenAI实现（备选）
@Component
public class OpenAIClient implements AIModelClient {
    
    @Value("${openai.api-key}")
    private String apiKey;
    
    @Override
    public String chat(List<Message> messages) {
        OpenAiService service = new OpenAiService(apiKey);
        ChatCompletionRequest request = ChatCompletionRequest.builder()
            .model("gpt-4")
            .messages(convertMessages(messages))
            .build();
        return service.createChatCompletion(request)
            .getChoices().get(0).getMessage().getContent();
    }
    
    @Override
    public Stream<String> chatStream(List<Message> messages) {
        // 流式输出实现
    }
}
```

### 4.4 豆包模型配置

豆包（Doubao）是火山引擎提供的大语言模型，作为系统默认的AI模型。

**支持的模型版本：**

| 模型名称 | 上下文长度 | 适用场景 |
|----------|------------|----------|
| doubao-pro-32k | 32K tokens | 通用对话、方案生成（默认） |
| doubao-pro-128k | 128K tokens | 长文档处理、复杂分析 |
| doubao-lite-32k | 32K tokens | 轻量级任务、快速响应 |
| doubao-lite-128k | 128K tokens | 长文档轻量处理 |

**API配置：**

```yaml
# application.yml
doubao:
  api-key: ${DOUBAO_API_KEY}
  api-endpoint: https://ark.cn-beijing.volces.com/api/v3/chat/completions
  default-model: doubao-pro-32k
  timeout: 60000
  max-tokens: 4096
```

**前端配置：**

```typescript
// .env
VITE_AI_PROVIDER=doubao
VITE_DOUBAO_API_KEY=your-api-key
VITE_DOUBAO_MODEL=doubao-pro-32k
VITE_DOUBAO_API_ENDPOINT=https://ark.cn-beijing.volces.com/api/v3/chat/completions
```

**API调用示例：**

```typescript
// 豆包API调用
const response = await fetch('https://ark.cn-beijing.volces.com/api/v3/chat/completions', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${apiKey}`
  },
  body: JSON.stringify({
    model: 'doubao-pro-32k',
    messages: [
      { role: 'system', content: '你是一个专业的项目管理助手' },
      { role: 'user', content: '帮我分解这个任务...' }
    ],
    temperature: 0.7,
    max_tokens: 4096
  })
});
```

---

## 5. 数据库设计

### 5.1 核心表结构

#### 5.1.1 用户相关

```sql
-- 用户表
CREATE TABLE `user` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
    `username` VARCHAR(50) NOT NULL UNIQUE,
    `email` VARCHAR(100) NOT NULL UNIQUE,
    `password` VARCHAR(255) NOT NULL,
    `nickname` VARCHAR(50),
    `avatar` VARCHAR(255),
    `phone` VARCHAR(20),
    `status` TINYINT DEFAULT 1 COMMENT '1:正常 0:禁用',
    `enterprise_id` BIGINT,
    `department_id` BIGINT,
    `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX `idx_enterprise` (`enterprise_id`),
    INDEX `idx_department` (`department_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 角色表
CREATE TABLE `role` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
    `name` VARCHAR(50) NOT NULL,
    `code` VARCHAR(50) NOT NULL UNIQUE,
    `description` VARCHAR(255),
    `enterprise_id` BIGINT,
    `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 用户角色关联表
CREATE TABLE `user_role` (
    `user_id` BIGINT NOT NULL,
    `role_id` BIGINT NOT NULL,
    PRIMARY KEY (`user_id`, `role_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 5.1.2 项目相关

```sql
-- 项目表
CREATE TABLE `project` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
    `name` VARCHAR(100) NOT NULL,
    `description` TEXT,
    `status` VARCHAR(20) DEFAULT 'active',
    `priority` VARCHAR(20) DEFAULT 'medium',
    `start_date` DATE,
    `end_date` DATE,
    `progress` INT DEFAULT 0,
    `owner_id` BIGINT NOT NULL,
    `enterprise_id` BIGINT NOT NULL,
    `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX `idx_owner` (`owner_id`),
    INDEX `idx_enterprise` (`enterprise_id`),
    INDEX `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 里程碑表
CREATE TABLE `milestone` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
    `project_id` BIGINT NOT NULL,
    `name` VARCHAR(100) NOT NULL,
    `description` TEXT,
    `due_date` DATE,
    `status` VARCHAR(20) DEFAULT 'pending',
    `progress` INT DEFAULT 0,
    `sort_order` INT DEFAULT 0,
    `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX `idx_project` (`project_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 任务表
CREATE TABLE `task` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
    `project_id` BIGINT NOT NULL,
    `milestone_id` BIGINT,
    `parent_id` BIGINT COMMENT '父任务ID',
    `title` VARCHAR(200) NOT NULL,
    `description` TEXT,
    `status` VARCHAR(20) DEFAULT 'todo',
    `priority` VARCHAR(20) DEFAULT 'medium',
    `assignee_id` BIGINT,
    `reporter_id` BIGINT,
    `start_date` DATE,
    `due_date` DATE,
    `estimated_hours` DECIMAL(10,2),
    `actual_hours` DECIMAL(10,2),
    `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX `idx_project` (`project_id`),
    INDEX `idx_milestone` (`milestone_id`),
    INDEX `idx_assignee` (`assignee_id`),
    INDEX `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 5.1.3 知识相关

```sql
-- 知识文档表
CREATE TABLE `knowledge_document` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
    `title` VARCHAR(200) NOT NULL,
    `content` LONGTEXT,
    `category_id` BIGINT,
    `type` VARCHAR(50),
    `tags` JSON,
    `author_id` BIGINT,
    `enterprise_id` BIGINT,
    `view_count` INT DEFAULT 0,
    `status` VARCHAR(20) DEFAULT 'draft',
    `vector_id` VARCHAR(100) COMMENT '向量库ID',
    `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX `idx_category` (`category_id`),
    INDEX `idx_author` (`author_id`),
    INDEX `idx_enterprise` (`enterprise_id`),
    FULLTEXT INDEX `ft_content` (`title`, `content`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 知识分类表
CREATE TABLE `knowledge_category` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
    `name` VARCHAR(100) NOT NULL,
    `parent_id` BIGINT,
    `enterprise_id` BIGINT,
    `sort_order` INT DEFAULT 0,
    `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 5.2 索引优化策略

| 表名 | 索引类型 | 索引字段 | 说明 |
|------|----------|----------|------|
| task | 复合索引 | (project_id, status) | 项目任务查询 |
| task | 复合索引 | (assignee_id, status, due_date) | 我的任务查询 |
| knowledge_document | 全文索引 | (title, content) | 全文搜索 |
| project | 复合索引 | (enterprise_id, status) | 企业项目列表 |

---

## 6. API设计规范

### 6.1 RESTful API规范

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              API设计规范                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  URL规范                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  GET    /api/v1/projects              获取项目列表                  │   │
│  │  GET    /api/v1/projects/{id}         获取项目详情                  │   │
│  │  POST   /api/v1/projects              创建项目                      │   │
│  │  PUT    /api/v1/projects/{id}         更新项目                      │   │
│  │  DELETE /api/v1/projects/{id}         删除项目                      │   │
│  │  GET    /api/v1/projects/{id}/tasks   获取项目任务                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  请求格式                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Content-Type: application/json                                     │   │
│  │  Authorization: Bearer {token}                                      │   │
│  │  X-Request-Id: {uuid}                                               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  响应格式                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  {                                                                  │   │
│  │    "code": 200,                                                     │   │
│  │    "message": "success",                                            │   │
│  │    "data": { ... },                                                 │   │
│  │    "timestamp": 1703664000000                                       │   │
│  │  }                                                                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  分页格式                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  {                                                                  │   │
│  │    "code": 200,                                                     │   │
│  │    "data": {                                                        │   │
│  │      "list": [...],                                                 │   │
│  │      "total": 100,                                                  │   │
│  │      "page": 1,                                                     │   │
│  │      "pageSize": 20                                                 │   │
│  │    }                                                                │   │
│  │  }                                                                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 错误码规范

| 错误码 | 说明 | HTTP状态码 |
|--------|------|------------|
| 200 | 成功 | 200 |
| 400 | 请求参数错误 | 400 |
| 401 | 未认证 | 401 |
| 403 | 无权限 | 403 |
| 404 | 资源不存在 | 404 |
| 500 | 服务器错误 | 500 |
| 1001 | 用户名已存在 | 400 |
| 1002 | 密码错误 | 400 |
| 2001 | 项目不存在 | 404 |
| 2002 | 无项目权限 | 403 |

---

## 7. 安全方案

### 7.1 安全架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              安全架构                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          网络安全层                                  │   │
│  │  • HTTPS加密传输 • WAF防火墙 • DDoS防护 • IP白名单                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          应用安全层                                  │   │
│  │  • JWT认证 • RBAC权限 • 接口限流 • SQL注入防护 • XSS防护           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          数据安全层                                  │   │
│  │  • 数据加密存储 • 敏感数据脱敏 • 数据备份 • 审计日志               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 认证授权

```java
// 权限注解
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface RequirePermission {
    String[] value();
    Logical logical() default Logical.AND;
}

// 权限拦截器
@Component
public class PermissionInterceptor implements HandlerInterceptor {
    
    @Autowired
    private PermissionService permissionService;
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                            HttpServletResponse response, 
                            Object handler) {
        if (handler instanceof HandlerMethod) {
            HandlerMethod method = (HandlerMethod) handler;
            RequirePermission annotation = method.getMethodAnnotation(RequirePermission.class);
            
            if (annotation != null) {
                Long userId = SecurityUtils.getCurrentUserId();
                String[] permissions = annotation.value();
                
                boolean hasPermission = annotation.logical() == Logical.AND
                    ? permissionService.hasAllPermissions(userId, permissions)
                    : permissionService.hasAnyPermission(userId, permissions);
                
                if (!hasPermission) {
                    throw new ForbiddenException("无权限访问");
                }
            }
        }
        return true;
    }
}
```

### 7.3 数据加密

```java
// 敏感数据加密
@Component
public class DataEncryptor {
    
    @Value("${encryption.key}")
    private String encryptionKey;
    
    public String encrypt(String plainText) {
        try {
            Cipher cipher = Cipher.getInstance("AES/GCM/NoPadding");
            SecretKeySpec keySpec = new SecretKeySpec(
                encryptionKey.getBytes(), "AES"
            );
            cipher.init(Cipher.ENCRYPT_MODE, keySpec);
            byte[] encrypted = cipher.doFinal(plainText.getBytes());
            return Base64.getEncoder().encodeToString(encrypted);
        } catch (Exception e) {
            throw new RuntimeException("加密失败", e);
        }
    }
    
    public String decrypt(String encryptedText) {
        try {
            Cipher cipher = Cipher.getInstance("AES/GCM/NoPadding");
            SecretKeySpec keySpec = new SecretKeySpec(
                encryptionKey.getBytes(), "AES"
            );
            cipher.init(Cipher.DECRYPT_MODE, keySpec);
            byte[] decrypted = cipher.doFinal(
                Base64.getDecoder().decode(encryptedText)
            );
            return new String(decrypted);
        } catch (Exception e) {
            throw new RuntimeException("解密失败", e);
        }
    }
}
```

---

## 8. 部署方案

### 8.1 容器化部署

```yaml
# docker-compose.yml
version: '3.8'

services:
  # 前端服务
  mota-web:
    build: ./mota-web
    ports:
      - "80:80"
    depends_on:
      - mota-gateway
    networks:
      - mota-network

  # API网关
  mota-gateway:
    build: ./mota-gateway
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
    depends_on:
      - mota-project
      - mota-user
      - mota-ai
    networks:
      - mota-network

  # 项目服务
  mota-project:
    build: ./mota-project-service
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - MYSQL_HOST=mysql
      - REDIS_HOST=redis
    depends_on:
      - mysql
      - redis
    networks:
      - mota-network

  # AI服务
  mota-ai:
    build: ./mota-ai-service
    environment:
      - MILVUS_HOST=milvus
      - NEO4J_HOST=neo4j
    depends_on:
      - milvus
      - neo4j
    networks:
      - mota-network

  # MySQL
  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=mota
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - mota-network

  # Redis
  redis:
    image: redis:7.0
    volumes:
      - redis-data:/data
    networks:
      - mota-network

  # Milvus向量数据库
  milvus:
    image: milvusdb/milvus:v2.3.0
    volumes:
      - milvus-data:/var/lib/milvus
    networks:
      - mota-network

  # Neo4j图数据库
  neo4j:
    image: neo4j:5.0
    environment:
      - NEO4J_AUTH=neo4j/password
    volumes:
      - neo4j-data:/data
    networks:
      - mota-network

volumes:
  mysql-data:
  redis-data:
  milvus-data:
  neo4j-data:

networks:
  mota-network:
    driver: bridge
```

### 8.2 Kubernetes部署

```yaml
# k8s/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mota-project-service
  namespace: mota
spec:
  replicas: 3
  selector:
    matchLabels:
      app: mota-project
  template:
    metadata:
      labels:
        app: mota-project
    spec:
      containers:
      - name: mota-project
        image: mota/project-service:latest
        ports:
        - containerPort: 8080
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "prod"
        - name: MYSQL_HOST
          valueFrom:
            configMapKeyRef:
              name: mota-config
              key: mysql-host
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: mota-project-service
  namespace: mota
spec:
  selector:
    app: mota-project
  ports:
  - port: 8080
    targetPort: 8080
  type: ClusterIP
```

### 8.3 CI/CD流程

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Build with Maven
      run: mvn clean package -DskipTests
    
    - name: Build Docker image
      run: |
        docker build -t mota/project-service:${{ github.sha }} .
        docker push mota/project-service:${{ github.sha }}
    
    - name: Deploy to Kubernetes
      run: |
        kubectl set image deployment/mota-project-service \
          mota-project=mota/project-service:${{ github.sha }} \
          -n mota
```

---

## 9. 监控方案

### 9.1 监控架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              监控架构                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          可视化层                                    │   │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐           │   │
│  │  │   Grafana     │  │   Kibana      │  │   Jaeger UI   │           │   │
│  │  │   指标可视化  │  │   日志可视化  │  │   链路追踪    │           │   │
│  │  └───────────────┘  └───────────────┘  └───────────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          数据存储层                                  │   │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐           │   │
│  │  │  Prometheus   │  │ Elasticsearch │  │    Jaeger     │           │   │
│  │  │   指标存储    │  │   日志存储    │  │   链路存储    │           │   │
│  │  └───────────────┘  └───────────────┘  └───────────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          数据采集层                                  │   │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐           │   │
│  │  │  Micrometer   │  │   Filebeat    │  │ OpenTelemetry │           │   │
│  │  │   指标采集    │  │   日志采集    │  │   链路采集    │           │   │
│  │  └───────────────┘  └───────────────┘  └───────────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 9.2 关键指标

| 指标类型 | 指标名称 | 告警阈值 | 说明 |
|----------|----------|----------|------|
| 系统 | CPU使用率 | >80% | 服务器负载 |
| 系统 | 内存使用率 | >85% | 内存压力 |
| 应用 | 请求响应时间 | >2s | 接口性能 |
| 应用 | 错误率 | >1% | 服务稳定性 |
| 业务 | 活跃用户数 | - | 用户活跃度 |
| 业务 | AI调用次数 | - | AI使用情况 |

---

*文档结束*