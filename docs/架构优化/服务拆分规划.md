# Mota 微服务架构拆分规划

## 一、当前架构问题

### 1.1 mota-project-service 职责过重

当前 `mota-project-service` 包含了40个控制器，承担了过多职责：

| 功能模块 | 控制器数量 | 说明 |
|---------|-----------|------|
| 项目管理 | 5 | ProjectController, MilestoneController, DeliverableController, ProgressReportController, ProgressTrackingController |
| 任务管理 | 7 | TaskController, SubtaskController, TaskCommentController, TaskDependencyController, TaskTemplateController, ChecklistController, WorkPlanController |
| 日历功能 | 3 | CalendarEventController, CalendarConfigController, CalendarSubscriptionController |
| 通知功能 | 1 | NotificationController |
| AI功能 | 6 | AIController, AIAssistantController, AIProposalController, AIProposalGenerationController, AIKnowledgeBaseController, MultiModelController |
| 知识管理 | 3 | KnowledgeGraphController, KnowledgeManagementController, KnowledgeStatisticsController |
| 文档管理 | 1 | DocumentController |
| 新闻功能 | 3 | NewsArticleController, SmartNewsPushController, CacheShardingController |
| 搜索功能 | 1 | SmartSearchController |
| 其他 | 10 | DashboardController, DepartmentController, DepartmentTaskController, ActivityController, UserController, UserViewConfigController, WorkflowController, WorkFeedbackController, ResourceManagementController, ReportAnalyticsController |

## 二、服务拆分方案

### 2.1 推荐的微服务架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        mota-gateway                              │
│                      (API网关 + 认证)                            │
└─────────────────────────────────────────────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        │                       │                       │
        ▼                       ▼                       ▼
┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│ mota-project  │     │   mota-ai     │     │ mota-knowledge│
│   -service    │     │   -service    │     │   -service    │
│               │     │               │     │               │
│ • 项目管理    │     │ • AI对话      │     │ • 知识文件    │
│ • 任务管理    │     │ • AI方案生成  │     │ • 模板管理    │
│ • 里程碑      │     │ • AI新闻      │     │ • 知识图谱    │
│ • 进度跟踪    │     │ • 多模型支持  │     │ • 知识统计    │
│ • 工作流      │     │ • AI知识库    │     │               │
└───────────────┘     └───────────────┘     └───────────────┘
        │                       │                       │
        ▼                       ▼                       ▼
┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│ mota-calendar │     │  mota-notify  │     │  mota-search  │
│   -service    │     │   -service    │     │   -service    │
│               │     │               │     │               │
│ • 日历事件    │     │ • 通知发送    │     │ • 智能搜索    │
│ • 日历订阅    │     │ • 通知聚合    │     │ • 搜索建议    │
│ • 日历配置    │     │ • 免打扰      │     │ • 搜索统计    │
│ • 任务同步    │     │ • 订阅管理    │     │               │
└───────────────┘     └───────────────┘     └───────────────┘
        │                       │                       │
        └───────────────────────┼───────────────────────┘
                                │
                                ▼
                    ┌───────────────────┐
                    │   mota-common     │
                    │                   │
                    │ • common-core     │
                    │ • common-security │
                    │ • common-redis    │
                    │ • common-mybatis  │
                    │ • common-feign    │
                    │ • common-log      │
                    └───────────────────┘
```

### 2.2 服务职责划分

#### mota-project-service（核心项目服务）
保留核心项目管理功能：
- 项目CRUD、项目成员管理
- 任务管理、子任务、任务依赖
- 里程碑管理
- 进度跟踪、进度报告
- 工作流管理
- 部门管理、部门任务
- 仪表盘、活动记录
- 资源管理、报表分析

#### mota-ai-service（AI服务）
整合所有AI相关功能：
- AI对话（从project-service迁移）
- AI方案生成（从project-service迁移）
- AI助手（从project-service迁移）
- AI新闻（已有）
- 多模型支持（从project-service迁移）
- AI知识库（从project-service迁移）

#### mota-knowledge-service（知识服务）
整合所有知识管理功能：
- 知识文件管理（已有）
- 模板管理（已有）
- 知识图谱（从project-service迁移）
- 知识统计（从project-service迁移）
- 文档管理（从project-service迁移）

#### mota-calendar-service（日历服务）
整合所有日历功能：
- 日历事件（从project-service迁移）
- 日历订阅（从project-service迁移）
- 日历配置（从project-service迁移）
- 任务日历同步

#### mota-notify-service（通知服务）
整合所有通知功能：
- 基础通知发送（已有）
- 通知聚合（从project-service迁移）
- 智能分类（从project-service迁移）
- 免打扰模式（从project-service迁移）
- 订阅管理（从project-service迁移）

#### mota-search-service（搜索服务）- 新建
独立搜索功能：
- 智能搜索（从project-service迁移）
- 搜索建议
- 搜索统计
- 向量搜索

## 三、服务间通信

### 3.1 OpenFeign客户端

已创建 `mota-common-feign` 模块，包含：

```
mota-common-feign/
├── src/main/java/com/mota/common/feign/
│   ├── client/
│   │   ├── NotifyServiceClient.java      # 通知服务客户端
│   │   ├── KnowledgeServiceClient.java   # 知识服务客户端
│   │   └── AIServiceClient.java          # AI服务客户端
│   ├── config/
│   │   ├── FeignConfig.java              # Feign全局配置
│   │   └── FeignErrorDecoder.java        # 错误解码器
│   ├── dto/
│   │   ├── NotificationDTO.java          # 通知DTO
│   │   ├── KnowledgeFileDTO.java         # 知识文件DTO
│   │   ├── TemplateDTO.java              # 模板DTO
│   │   └── AINewsDTO.java                # AI新闻DTO
│   └── fallback/
│       ├── NotifyServiceFallback.java    # 通知服务降级
│       ├── KnowledgeServiceFallback.java # 知识服务降级
│       └── AIServiceFallback.java        # AI服务降级
└── src/main/resources/
    └── META-INF/spring/
        └── org.springframework.boot.autoconfigure.AutoConfiguration.imports
```

### 3.2 使用方式

在需要调用其他服务的微服务中：

1. 添加依赖：
```xml
<dependency>
    <groupId>com.mota</groupId>
    <artifactId>mota-common-feign</artifactId>
    <version>${project.version}</version>
</dependency>
```

2. 启用Feign客户端：
```java
@SpringBootApplication
@EnableFeignClients(basePackages = "com.mota.common.feign.client")
public class ProjectApplication {
    public static void main(String[] args) {
        SpringApplication.run(ProjectApplication.class, args);
    }
}
```

3. 注入并使用：
```java
@Service
@RequiredArgsConstructor
public class TaskService {
    
    private final NotifyServiceClient notifyServiceClient;
    
    public void completeTask(Long taskId) {
        // 完成任务逻辑...
        
        // 发送通知
        NotificationDTO notification = NotificationDTO.builder()
            .userId(assigneeId)
            .type("task_completed")
            .title("任务已完成")
            .content("任务 " + taskName + " 已完成")
            .build();
        notifyServiceClient.sendNotification(notification);
    }
}
```

## 四、API路径规范

### 4.1 统一前缀

所有API必须使用 `/api/v1/` 前缀：

| 服务 | API路径 |
|-----|---------|
| 项目服务 | `/api/v1/projects/**`, `/api/v1/tasks/**`, `/api/v1/milestones/**` |
| AI服务 | `/api/v1/ai/**` |
| 知识服务 | `/api/v1/knowledge/**` |
| 日历服务 | `/api/v1/calendar-events/**`, `/api/v1/calendar-configs/**` |
| 通知服务 | `/api/v1/notifications/**` |
| 搜索服务 | `/api/v1/search/**` |

### 4.2 网关路由配置

网关路由必须按照从具体到通用的顺序配置：

```yaml
# 正确顺序示例
routes:
  # 1. 最具体的路由
  - id: mota-ai-news-service
    uri: lb://mota-ai-service
    predicates:
      - Path=/api/v1/ai/news/**
  
  # 2. 次具体的路由
  - id: mota-ai-assistant-service
    uri: lb://mota-project-service
    predicates:
      - Path=/api/v1/ai/assistant/**
  
  # 3. 通用路由（放在最后）
  - id: mota-ai-general-service
    uri: lb://mota-project-service
    predicates:
      - Path=/api/v1/ai/**
```

## 五、迁移步骤

### 5.1 第一阶段：基础设施准备（已完成）
- [x] 创建 `mota-common-feign` 模块
- [x] 定义服务间通信接口
- [x] 实现降级处理
- [x] 优化网关路由配置

### 5.2 第二阶段：AI服务整合
- [ ] 将 `AIController` 迁移到 `mota-ai-service`
- [ ] 将 `AIAssistantController` 迁移到 `mota-ai-service`
- [ ] 将 `AIProposalController` 迁移到 `mota-ai-service`
- [ ] 将 `AIProposalGenerationController` 迁移到 `mota-ai-service`
- [ ] 将 `AIKnowledgeBaseController` 迁移到 `mota-ai-service`
- [ ] 将 `MultiModelController` 迁移到 `mota-ai-service`
- [ ] 更新网关路由

### 5.3 第三阶段：知识服务整合
- [ ] 将 `KnowledgeGraphController` 迁移到 `mota-knowledge-service`
- [ ] 将 `KnowledgeManagementController` 迁移到 `mota-knowledge-service`
- [ ] 将 `KnowledgeStatisticsController` 迁移到 `mota-knowledge-service`
- [ ] 将 `DocumentController` 迁移到 `mota-knowledge-service`
- [ ] 更新网关路由

### 5.4 第四阶段：日历服务整合
- [ ] 将 `CalendarEventController` 迁移到 `mota-calendar-service`
- [ ] 将 `CalendarConfigController` 迁移到 `mota-calendar-service`
- [ ] 将 `CalendarSubscriptionController` 迁移到 `mota-calendar-service`
- [ ] 实现任务-日历同步的Feign调用
- [ ] 更新网关路由

### 5.5 第五阶段：通知服务整合
- [ ] 将高级通知功能迁移到 `mota-notify-service`
- [ ] 实现通知聚合、智能分类等功能
- [ ] 更新网关路由

### 5.6 第六阶段：搜索服务独立
- [ ] 创建 `mota-search-service` 微服务
- [ ] 将 `SmartSearchController` 迁移到新服务
- [ ] 实现向量搜索功能
- [ ] 更新网关路由

## 六、注意事项

1. **数据库设计**：每个微服务应该有独立的数据库schema，避免跨服务直接访问数据库
2. **事务处理**：跨服务操作需要使用分布式事务或最终一致性方案
3. **服务发现**：使用Nacos进行服务注册与发现
4. **配置管理**：使用Nacos Config进行统一配置管理
5. **链路追踪**：建议引入SkyWalking或Zipkin进行分布式链路追踪
6. **熔断降级**：已在Feign客户端中实现降级处理，确保服务高可用

## 七、预期收益

1. **职责清晰**：每个服务职责单一，便于维护和扩展
2. **独立部署**：各服务可以独立部署和扩缩容
3. **技术栈灵活**：不同服务可以使用最适合的技术栈
4. **故障隔离**：单个服务故障不会影响整体系统
5. **团队协作**：不同团队可以并行开发不同服务