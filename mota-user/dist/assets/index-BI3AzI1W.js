import{r,j as e,S as E}from"./index-jJjkrASA.js";import{p as $,s as K,i as x}from"./api-DUmAbDc_.js";import{B as g}from"./button-Bv8EyRxh.js";import{R as M}from"./PlusOutlined-Bh2Mv01n.js";import{S as k}from"./index-DDqd5aTF.js";import{I as z}from"./index-DR1THxsW.js";import{R as O}from"./SearchOutlined-OiCr0NYv.js";import{D as q}from"./index-BUg6PNCH.js";import{R as G}from"./MoreOutlined-CjOKr4kg.js";import{s as u}from"./index-C54hh6U9.js";import{T as J}from"./index-C-XfQ0lz.js";import{R as Q}from"./ClockCircleOutlined-CiuAMI-C.js";import{A as v}from"./index-CzYeSCDM.js";import{R as U}from"./UserOutlined-eSGHSk0-.js";import"./compact-item-CfP0ZfjF.js";import"./RightOutlined-CFLGXWAw.js";import"./getAllowClear-DijkFjz0.js";import"./CloseCircleFilled-DzUWwAnM.js";import"./EllipsisOutlined-Bct-hJoY.js";import"./DownOutlined-CN1mv8sD.js";import"./PurePanel-BjAOE1jZ.js";import"./move-DCQK6w6D.js";import"./CheckOutlined-CH83bvZX.js";import"./CloseOutlined-JFFLTca6.js";import"./Input-BYqifNCC.js";import"./TextArea-D2UEp3z5.js";import"./LeftOutlined-DSxe2Naa.js";import"./index-DEZvTLAg.js";import"./CheckCircleFilled-C1tkfSYQ.js";import"./ExclamationCircleFilled-CjD5Kf6C.js";import"./useClosable-Dcdur4ya.js";import"./extendsObject-78o_rR5W.js";import"./index-D31JVHEt.js";const V="_kanban_ot9yk_1",W="_header_ot9yk_15",X="_headerActions_ot9yk_41",Y="_toolbar_ot9yk_51",Z="_filters_ot9yk_59",ss="_loading_ot9yk_69",es="_board_ot9yk_85",ts="_column_ot9yk_101",os="_columnHeader_ot9yk_119",as="_columnTitle_ot9yk_135",rs="_columnCount_ot9yk_149",is="_columnLimit_ot9yk_175",ns="_columnBody_ot9yk_185",cs="_emptyColumn_ot9yk_203",ls="_issueCard_ot9yk_225",ds="_cardHeader_ot9yk_261",ms="_issueType_ot9yk_275",us="_issueKey_ot9yk_287",ps="_issuePriority_ot9yk_299",ys="_cardBody_ot9yk_309",_s="_issueTitle_ot9yk_317",hs="_cardFooter_ot9yk_339",fs="_cardMeta_ot9yk_351",js="_storyPoints_ot9yk_363",xs="_dueDate_ot9yk_379",gs="_assignee_ot9yk_395",o={kanban:V,header:W,headerActions:X,toolbar:Y,filters:Z,loading:ss,board:es,column:ts,columnHeader:os,columnTitle:as,columnCount:rs,columnLimit:is,columnBody:ns,emptyColumn:cs,issueCard:ls,cardHeader:ds,issueType:ms,issueKey:us,issuePriority:ps,cardBody:ys,issueTitle:_s,cardFooter:hs,cardMeta:fs,storyPoints:js,dueDate:xs,assignee:gs},se=()=>{const[N,p]=r.useState(!0),[S,b]=r.useState([]),[T,w]=r.useState([]),[n,y]=r.useState(),[l,_]=r.useState(),[C,D]=r.useState(""),[d,h]=r.useState([{id:"open",title:"待处理",status:"open",issues:[],limit:10},{id:"in_progress",title:"进行中",status:"in_progress",issues:[],limit:5},{id:"review",title:"待评审",status:"review",issues:[],limit:5},{id:"done",title:"已完成",status:"done",issues:[]}]),[c,f]=r.useState(null);r.useEffect(()=>{I()},[]),r.useEffect(()=>{n&&P()},[n]),r.useEffect(()=>{j()},[n,l]);const I=async()=>{try{const s=await $.getProjects(),t=s.data.list||s.data;b(t),t.length>0&&y(t[0].id)}catch(s){console.error("Failed to load projects:",s)}},P=async()=>{try{const s=await K.getSprints({projectId:n}),t=Array.isArray(s.data)?s.data:s.data.list||[];w(t);const i=t.find(a=>a.status==="active");i&&_(i.id)}catch(s){console.error("Failed to load sprints:",s)}},j=async()=>{if(n){p(!0);try{const t=(await x.getIssues({projectId:n,sprintId:l})).data.list||[],i=d.map(a=>({...a,issues:t.filter(m=>m.status===a.status)}));h(i)}catch(s){console.error("Failed to load issues:",s)}finally{p(!1)}}},A=(s,t)=>{f(t),s.dataTransfer.effectAllowed="move"},R=s=>{s.preventDefault(),s.dataTransfer.dropEffect="move"},B=async(s,t)=>{if(s.preventDefault(),!c)return;if(t.limit&&t.issues.length>=t.limit){u.warning(`${t.title} 列已达到在制品限制 (${t.limit})`);return}const i=d.map(a=>a.id===t.id?{...a,issues:[...a.issues,{...c,status:a.status}]}:{...a,issues:a.issues.filter(m=>m.id!==c.id)});h(i);try{await x.updateIssue(c.id,{status:t.status}),u.success("状态已更新")}catch{u.error("更新失败"),j()}f(null)},H=s=>({story:"#52c41a",task:"#1677ff",bug:"#ff4d4f",epic:"#722ed1"})[s]||"#8c8c8c",F=s=>{const t={highest:{color:"#ff4d4f",icon:"⬆⬆"},high:{color:"#fa8c16",icon:"⬆"},medium:{color:"#1677ff",icon:"➡"},low:{color:"#52c41a",icon:"⬇"},lowest:{color:"#8c8c8c",icon:"⬇⬇"}},i=t[s]||t.medium;return e.jsx("span",{style:{color:i.color},children:i.icon})},L=s=>e.jsxs("div",{className:o.issueCard,draggable:!0,onDragStart:t=>A(t,s),children:[e.jsxs("div",{className:o.cardHeader,children:[e.jsx("span",{className:o.issueType,style:{backgroundColor:H(s.type)}}),e.jsx("span",{className:o.issueKey,children:s.key}),e.jsx("span",{className:o.issuePriority,children:F(s.priority)})]}),e.jsx("div",{className:o.cardBody,children:e.jsx("p",{className:o.issueTitle,children:s.title})}),e.jsxs("div",{className:o.cardFooter,children:[e.jsxs("div",{className:o.cardMeta,children:[s.storyPoints&&e.jsx(J,{className:o.storyPoints,children:s.storyPoints}),s.dueDate&&e.jsxs("span",{className:o.dueDate,children:[e.jsx(Q,{})," ",s.dueDate]})]}),s.assigneeName?e.jsx(v,{size:"small",className:o.assignee,children:s.assigneeName.charAt(0)}):e.jsx(v,{size:"small",icon:e.jsx(U,{}),className:o.assignee})]})]},s.id);return e.jsxs("div",{className:o.kanban,children:[e.jsxs("div",{className:o.header,children:[e.jsx("h2",{children:"看板"}),e.jsx("div",{className:o.headerActions,children:e.jsx(g,{type:"primary",icon:e.jsx(M,{}),children:"创建事项"})})]}),e.jsx("div",{className:o.toolbar,children:e.jsxs("div",{className:o.filters,children:[e.jsx(k,{placeholder:"选择项目",value:n,onChange:y,style:{width:180},options:S.map(s=>({value:s.id,label:s.name}))}),e.jsx(k,{placeholder:"选择迭代",value:l,onChange:_,style:{width:180},allowClear:!0,options:T.map(s=>({value:s.id,label:s.name}))}),e.jsx(z,{placeholder:"搜索事项",prefix:e.jsx(O,{}),value:C,onChange:s=>D(s.target.value),style:{width:200},allowClear:!0})]})}),N?e.jsx("div",{className:o.loading,children:e.jsx(E,{size:"large"})}):e.jsx("div",{className:o.board,children:d.map(s=>e.jsxs("div",{className:o.column,onDragOver:R,onDrop:t=>B(t,s),children:[e.jsxs("div",{className:o.columnHeader,children:[e.jsxs("div",{className:o.columnTitle,children:[e.jsx("span",{children:s.title}),e.jsx("span",{className:o.columnCount,children:s.issues.length}),s.limit&&e.jsxs("span",{className:o.columnLimit,children:["/ ",s.limit]})]}),e.jsx(q,{menu:{items:[{key:"add",label:"添加事项"},{key:"settings",label:"列设置"}]},trigger:["click"],children:e.jsx(g,{type:"text",size:"small",icon:e.jsx(G,{})})})]}),e.jsxs("div",{className:o.columnBody,children:[s.issues.map(t=>L(t)),s.issues.length===0&&e.jsx("div",{className:o.emptyColumn,children:"拖拽事项到此处"})]})]},s.id))})]})};export{se as default};
