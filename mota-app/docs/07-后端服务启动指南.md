# 后端服务启动指南

## 概述

mota-app 前端已完整配置好与 mota-service 后端的API连接。本文档说明如何启动后端服务并验证前后端连接。

## 架构说明

### API网关架构
```
mota-app (前端)
    ↓
http://localhost:8080 (API网关)
    ↓
├─ /api/v1/auth/**        → mota-auth-service (认证服务)
├─ /api/v1/projects/**    → mota-project-service (项目服务)
├─ /api/v1/tasks/**       → mota-project-service (任务服务)
├─ /api/v1/ai/**          → mota-ai-service (AI服务)
├─ /api/v1/knowledge/**   → mota-knowledge-service (知识服务)
└─ ... (更多服务路由)
```

### 前端配置
- **开发环境**: `http://localhost:8080` (已配置在 `.env.development`)
- **生产环境**: `https://api.mota.com` (已配置在 `.env.production`)

## 快速启动

### 方式一：使用Docker Compose（推荐）

**1. 启动基础中间件**
```bash
cd mota-service
docker-compose -f docker/docker-compose.yml up -d
```

这将启动：
- MySQL (端口3306)
- Redis (端口6379)
- Nacos (端口8848)

**2. 启动网关服务**
```bash
# 在 mota-service 目录下
mvn clean install
cd mota-gateway
mvn spring-boot:run
```

网关将运行在 `http://localhost:8080`

**3. 启动核心服务**

根据需要启动以下服务（每个在新终端窗口）：

```bash
# 认证服务 (端口8081)
cd mota-auth-service
mvn spring-boot:run

# 项目服务 (端口8082) - 核心服务，包含项目、任务、用户等
cd mota-project-service
mvn spring-boot:run

# AI服务 (端口8083) - 可选
cd mota-ai-service
mvn spring-boot:run

# 知识服务 (端口8084) - 可选
cd mota-knowledge-service
mvn spring-boot:run
```

### 方式二：最小化启动（快速测试）

如果只是测试前后端连接，最少需要启动：

**1. 启动MySQL和Redis**
```bash
cd mota-service/docker
docker-compose up -d mysql redis
```

**2. 初始化数据库**
```bash
# 连接MySQL并执行初始化脚本
mysql -h localhost -u mota -p mota123 < sql/init-db-single.sql
mysql -h localhost -u mota -p mota123 < sql/init-default-data.sql
```

**3. 启动网关（不使用Nacos）**

修改 `mota-gateway/src/main/resources/application.yml`:
```yaml
spring:
  cloud:
    nacos:
      discovery:
        enabled: false  # 禁用Nacos
    gateway:
      routes:
        # 将 lb://service-name 改为直接URL
        - id: mota-auth-service
          uri: http://localhost:8081  # 直接指向服务
```

**4. 启动核心服务**
```bash
# 认证服务
cd mota-auth-service
mvn spring-boot:run

# 项目服务
cd mota-project-service
mvn spring-boot:run

# 网关
cd mota-gateway
mvn spring-boot:run
```

## 验证连接

### 1. 检查服务状态

**访问网关健康检查**:
```bash
curl http://localhost:8080/actuator/health
```

预期响应：
```json
{
  "status": "UP"
}
```

**查看网关路由列表**:
```bash
curl http://localhost:8080/actuator/gateway/routes
```

### 2. 测试认证接口

**获取图形验证码**:
```bash
curl http://localhost:8080/api/v1/auth/captcha
```

**测试登录**:
```bash
curl -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123"
  }'
```

预期响应：
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "...",
    "user": {
      "id": "1",
      "username": "admin",
      "nickname": "管理员"
    }
  }
}
```

### 3. 在移动端测试

**启动移动端H5**:
```bash
cd mota-app
npm run dev:h5
```

访问 `http://localhost:3000`，尝试：
1. 点击登录按钮
2. 输入用户名: `admin`
3. 输入密码: `admin123`
4. 观察浏览器Network面板，查看API请求

预期看到：
- 请求发往: `http://localhost:8080/api/v1/auth/login`
- 响应状态: `200 OK`
- 响应包含token和用户信息

## 服务端口列表

| 服务 | 端口 | 说明 |
|------|------|------|
| mota-gateway | 8080 | **API网关（前端连接此端口）** |
| mota-auth-service | 8081 | 认证服务 |
| mota-project-service | 8082 | 项目服务（核心） |
| mota-ai-service | 8083 | AI服务 |
| mota-knowledge-service | 8084 | 知识服务 |
| mota-task-service | 8085 | 任务服务 |
| mota-user-service | 8086 | 用户服务 |
| MySQL | 3306 | 数据库 |
| Redis | 6379 | 缓存 |
| Nacos | 8848 | 服务注册中心 |

## 环境变量配置

### 网关环境变量
```bash
# JWT密钥（必须）
export JWT_SECRET="bW90YS1zZWNyZXQta2V5..."

# Nacos服务器（可选，默认localhost:8848）
export NACOS_SERVER=localhost:8848

# Redis配置（可选）
export REDIS_HOST=localhost
export REDIS_PORT=6379
export REDIS_PASSWORD=
```

### 数据库环境变量
```bash
# 项目服务数据库
export DB_HOST=localhost
export DB_PORT=3306
export DB_NAME=mota_project
export DB_USERNAME=mota
export DB_PASSWORD=mota123
```

## 常见问题

### 1. 前端请求失败：CORS错误

**症状**: 浏览器控制台显示跨域错误

**解决**: 网关已配置全局CORS，检查网关是否正常启动
```yaml
# mota-gateway/application.yml
spring.cloud.gateway.globalcors:
  cors-configurations:
    '[/**]':
      allowed-origin-patterns: "*"
```

### 2. 401 未授权错误

**症状**: 所有接口返回401

**原因**: 
- JWT密钥不匹配
- Token已过期
- 白名单配置错误

**解决**:
1. 检查网关JWT配置
2. 确认登录接口在白名单中
3. 查看网关日志

### 3. 503 服务不可用

**症状**: 网关返回503

**原因**:
- 目标微服务未启动
- Nacos未连接
- 服务未注册

**解决**:
1. 检查目标服务是否运行: `curl http://localhost:8082/actuator/health`
2. 检查Nacos控制台: `http://localhost:8848/nacos`
3. 查看网关路由配置

### 4. 请求超时

**症状**: 请求长时间无响应

**解决**:
```yaml
# 调整网关超时配置
spring:
  cloud:
    gateway:
      httpclient:
        connect-timeout: 60000
        response-timeout: 60000
```

## 开发建议

### 使用Nacos（推荐）

**优势**:
- 自动服务发现
- 配置中心
- 健康检查
- 支持灰度发布

**启动**:
```bash
docker run -d \
  --name nacos \
  -e MODE=standalone \
  -p 8848:8848 \
  nacos/nacos-server:latest
```

访问: `http://localhost:8848/nacos` (用户名/密码: nacos/nacos)

### 不使用Nacos（简化开发）

**修改网关配置**:
```yaml
spring:
  cloud:
    nacos:
      discovery:
        enabled: false
    gateway:
      discovery:
        locator:
          enabled: false
      routes:
        - id: mota-project-service
          uri: http://localhost:8082  # 直接URL
          predicates:
            - Path=/api/v1/projects/**
```

## API文档

### Swagger UI
启动服务后访问：
- 网关聚合文档: `http://localhost:8080/doc.html`
- 项目服务文档: `http://localhost:8082/swagger-ui.html`

### API前缀说明
所有API请求必须带 `/api/v1` 前缀：
- ✅ `http://localhost:8080/api/v1/auth/login`
- ❌ `http://localhost:8080/auth/login`

## 性能优化

### 1. 启用连接池
```yaml
spring:
  cloud:
    gateway:
      httpclient:
        pool:
          max-connections: 500
          max-idle-time: 60000
```

### 2. 启用响应缓存
```yaml
spring:
  cache:
    type: redis
    redis:
      time-to-live: 3600000
```

### 3. 调整线程池
```yaml
server:
  netty:
    connection-timeout: 60000
```

## 监控和日志

### 查看网关日志
```bash
# 实时查看
tail -f mota-gateway/logs/gateway.log

# 搜索错误
grep ERROR mota-gateway/logs/gateway.log
```

### Prometheus监控
访问: `http://localhost:8080/actuator/prometheus`

### 健康检查
```bash
# 网关健康
curl http://localhost:8080/actuator/health

# 服务详细健康信息
curl http://localhost:8080/actuator/health/liveness
curl http://localhost:8080/actuator/health/readiness
```

## 总结

✅ **前端配置**: 已完成，指向 `http://localhost:8080`  
✅ **网关配置**: 已完成，包含完整路由规则  
✅ **服务路由**: 已配置15个微服务路由  
✅ **认证鉴权**: JWT认证已配置  
✅ **跨域处理**: 全局CORS已启用  

**下一步**: 启动后端服务，即可开始前后端联调！