# 移动端增强功能说明

## 概述

本文档详细说明Mota App移动端新增的增强功能，包括离线功能管理器、推送通知服务和API服务封装。这些功能显著提升了移动端应用的稳定性和用户体验。

## 功能架构

### 1. 离线功能管理器 (Offline Manager)

**核心特性：**
- 智能离线队列管理
- 自动同步与重试机制
- 实时网络状态检测
- 数据完整性保障

**实现原理：**
```typescript
// 离线操作队列
interface SyncOperation {
  id: string
  type: 'create' | 'update' | 'delete'
  entity: 'task' | 'project' | 'comment'
  data: any
  timestamp: number
  retryCount: number
  status: 'pending' | 'processing' | 'completed' | 'failed'
}
```

**使用示例：**
```typescript
// 添加离线操作
const operationId = addOperation('update', 'task', {
  id: taskId,
  status: 'completed'
})

// 检查网络状态
const onlineStatus = isOnline.value

// 手动触发同步
await syncQueue()
```

### 2. 推送通知服务 (Notification Service)

**通知类型：**
- **任务通知**: 状态变更、到期提醒、评论通知
- **项目通知**: 进度更新、成员变更、归档通知
- **系统通知**: 离线操作、同步状态、系统消息

**优先级管理：**
- **高优先级**: 紧急任务、系统错误
- **中优先级**: 常规任务、项目更新
- **低优先级**: 信息性通知、系统消息

**使用示例：**
```typescript
// 发送任务通知
sendTaskNotification(taskId, 'updated', { status: 'completed' })

// 发送自定义通知
sendNotification({
  title: '操作已保存',
  message: '网络恢复后将自动同步到服务器',
  type: 'info',
  priority: 'normal',
  category: 'system'
})
```

### 3. API服务封装 (API Service)

**统一接口：**
```typescript
// 任务相关API
export const api = {
  // 任务管理
  getTasks: (params?: TaskQueryParams) => request<Task[]>('/api/tasks', { params }),
  createTask: (data: CreateTaskRequest) => request<Task>('/api/tasks', { method: 'POST', data }),
  updateTask: (id: string, data: UpdateTaskRequest) => request<Task>(`/api/tasks/${id}`, { method: 'PUT', data }),
  deleteTask: (id: string) => request<void>(`/api/tasks/${id}`, { method: 'DELETE' }),
  
  // 项目管理
  getProjects: (params?: ProjectQueryParams) => request<Project[]>('/api/projects', { params }),
  createProject: (data: CreateProjectRequest) => request<Project>('/api/projects', { method: 'POST', data }),
  updateProject: (id: string, data: UpdateProjectRequest) => request<Project>(`/api/projects/${id}`, { method: 'PUT', data }),
  deleteProject: (id: string) => request<void>(`/api/projects/${id}`, { method: 'DELETE' }),
  
  // 评论管理
  addTaskComment: (taskId: string, comment: string) => request<Comment>(`/api/tasks/${taskId}/comments`, { method: 'POST', data: { content: comment } }),
  
  // 用户管理
  getUserInfo: () => request<User>('/api/user/info'),
  updateUserProfile: (data: UpdateUserRequest) => request<User>('/api/user/profile', { method: 'PUT', data })
}
```

## 集成说明

### 1. 应用启动配置

**App.vue 中的初始化：**
```typescript
onLaunch(() => {
  // 初始化应用配置
  appStore.initialize()
  
  // 初始化用户数据
  userStore.initialize()
  
  // 初始化项目数据
  projectStore.initialize()
  
  // 初始化任务数据
  taskStore.initialize()
  
  // 初始化离线管理器
  offlineManager.init()
  
  // 初始化通知服务
  notificationService.init()
})
```

### 2. 页面集成示例

**任务详情页面集成：**
```typescript
// 导入服务
import { useOffline } from '@/services/offline'
import { useNotification } from '@/services/notification'

// 使用服务
const { addOperation, isOnline } = useOffline()
const { sendNotification, sendTaskNotification } = useNotification()

// 更新任务状态（支持离线）
const updateTaskStatus = async (status: string) => {
  if (!isOnline.value) {
    // 离线操作
    const operationId = addOperation('update', 'task', {
      id: taskId.value,
      status: status
    })
    
    sendNotification({
      title: '操作已保存',
      message: '网络恢复后将自动同步到服务器',
      type: 'info',
      priority: 'normal',
      category: 'system'
    })
  } else {
    // 在线操作
    const result = await taskStore.setTaskStatus(taskId.value, status)
    
    if (result.success) {
      sendTaskNotification(taskId.value, 'updated', { status })
    }
  }
}
```

## 配置参数

### 1. 离线管理器配置

**默认配置：**
```typescript
const defaultConfig = {
  // 同步间隔（毫秒）
  syncInterval: 30000,
  
  // 最大重试次数
  maxRetryCount: 3,
  
  // 重试延迟（毫秒）
  retryDelay: 5000,
  
  // 队列最大长度
  maxQueueSize: 100,
  
  // 自动同步开关
  autoSync: true
}
```

### 2. 通知服务配置

**平台适配：**
```typescript
const platformConfig = {
  // iOS配置
  ios: {
    badge: true,
    sound: 'default',
    alert: true
  },
  
  // Android配置
  android: {
    channelId: 'mota_notifications',
    channelName: 'Mota通知',
    importance: 'high'
  },
  
  // H5配置
  h5: {
    useNative: false,
    showInPage: true
  }
}
```

## 错误处理

### 1. 离线操作错误

**错误类型：**
- 网络连接失败
- 服务器响应超时
- 数据格式错误
- 权限不足

**处理策略：**
```typescript
// 错误处理示例
try {
  await executeOperation(operation)
} catch (error) {
  if (error.code === 'NETWORK_ERROR') {
    // 网络错误，重试
    operation.retryCount++
    if (operation.retryCount < maxRetryCount) {
      setTimeout(() => retryOperation(operation), retryDelay)
    } else {
      operation.status = 'failed'
      sendNotification({
        title: '同步失败',
        message: '请检查网络连接后重试',
        type: 'error',
        priority: 'high',
        category: 'system'
      })
    }
  }
}
```

## 性能优化

### 1. 离线队列优化

- **批量同步**: 合并多个操作减少网络请求
- **增量同步**: 只同步变更数据
- **智能重试**: 根据错误类型调整重试策略
- **内存管理**: 定期清理已完成的队列项

### 2. 通知性能

- **节流控制**: 避免频繁通知干扰用户
- **分组显示**: 相关通知合并显示
- **本地存储**: 通知历史本地缓存
- **权限管理**: 按用户设置控制通知频率

## 测试指南

### 1. 离线功能测试

**测试场景：**
- 网络断开时操作保存
- 网络恢复后自动同步
- 同步失败重试机制
- 队列溢出处理

**测试命令：**
```bash
# 模拟网络断开
npm run test:offline

# 测试同步功能
npm run test:sync
```

### 2. 通知功能测试

**测试场景：**
- 多平台通知显示
- 通知点击响应
- 通知权限管理
- 通知历史记录

## 常见问题

### Q: 离线操作如何保证数据一致性？
A: 通过操作队列和重试机制确保每个操作最终都会同步到服务器，同时本地状态会立即更新。

### Q: 通知服务支持哪些平台？
A: 支持iOS、Android、H5以及微信小程序，每个平台都有相应的适配配置。

### Q: API服务如何与后端对接？
A: API服务基于统一的HTTP请求封装，支持RESTful接口和WebSocket通信。

## 更新日志

### 2026-02-27
- ✅ 完成离线功能管理器开发
- ✅ 完成推送通知服务开发
- ✅ 完成API服务封装
- ✅ 集成到任务和项目页面
- ✅ 更新相关文档

---

**最后更新**: 2026-02-27
**版本**: 1.0.0
**状态**: ✅ 开发完成