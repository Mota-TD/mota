# mota-app 移动端部署指南

## 概述

本文档提供 mota-app 移动端应用的完整部署指南，涵盖开发、测试到生产环境的各个阶段。

## 目录
- [开发环境部署](#开发环境部署)
- [测试环境部署](#测试环境部署)
- [生产环境部署](#生产环境部署)
- [应用商店发布](#应用商店发布)
- [常见问题](#常见问题)

---

## 开发环境部署

### 环境要求

**必需软件**:
- Node.js >= 16.x
- npm >= 8.x
- HBuilderX >= 3.8.0 (用于Android/iOS开发)

**可选软件**:
- Android Studio (Android原生开发)
- Xcode (iOS原生开发，仅macOS)

### 1. H5开发模式（Web浏览器）

最快速的开发方式，支持热更新。

```bash
# 安装依赖
cd mota-app
npm install

# 启动H5开发服务器
npm run dev:h5

# 访问 http://localhost:3000
```

**特点**:
- ✅ 最快的启动速度
- ✅ 热模块替换（HMR）
- ✅ Chrome DevTools调试
- ❌ 无法测试原生功能（相机、推送等）

### 2. Android开发模式

使用HBuilderX进行Android应用开发。

**步骤1: 导入项目到HBuilderX**
1. 打开HBuilderX
2. 文件 → 导入 → 从本地目录导入
3. 选择 `mota-app` 目录

**步骤2: 配置Android SDK**
1. 工具 → 设置 → 运行配置
2. 配置Android SDK路径
3. 配置gradle路径

**步骤3: 运行到真机/模拟器**
1. 连接Android设备（启用USB调试）
2. 运行 → 运行到手机或模拟器 → Android设备
3. 选择设备后点击运行

**详细步骤**: 参考 [`06-HBuilderX启动Android项目指南.md`](./06-HBuilderX启动Android项目指南.md)

### 3. iOS开发模式（仅macOS）

**步骤1: 在HBuilderX中运行**
1. 运行 → 运行到手机或模拟器 → iOS模拟器
2. 首次运行会自动生成iOS项目

**步骤2: 使用Xcode调试**
1. 打开 `mota-app/unpackage/resources/__UNI__XXXXXX/` 目录
2. 双击 `.xcworkspace` 文件
3. 选择设备/模拟器
4. 点击运行按钮

---

## 测试环境部署

### H5测试部署

**1. 构建生产包**
```bash
npm run build:h5
```

**2. 部署到Nginx**
```nginx
server {
    listen 80;
    server_name test-app.mota.com;
    
    root /var/www/mota-app/dist/build/h5;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API代理
    location /api/ {
        proxy_pass http://test-gateway.mota.com:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

**3. 配置环境变量**

创建 `.env.test`:
```bash
VITE_API_BASE_URL=http://test-gateway.mota.com:8080
VITE_APP_TITLE=摩塔测试版
```

构建测试版本:
```bash
npm run build:h5 -- --mode test
```

### Android测试部署

**1. 配置manifest.json**

更新应用信息:
```json
{
  "name": "摩塔测试版",
  "appid": "__UNI__XXXXXX",
  "versionName": "1.0.0-beta",
  "versionCode": "100"
}
```

**2. 云打包（推荐）**

使用HBuilderX云打包:
1. 发行 → 原生App-云打包
2. 选择Android
3. 使用DCloud公用证书（测试用）
4. 勾选"生成测试包"
5. 打包

下载APK后分发给测试人员。

**3. 本地打包**

使用Android Studio:
```bash
# 生成离线打包资源
HBuilderX → 发行 → 原生App-本地打包 → 生成本地打包App资源

# 拷贝资源到Android项目
cp -r unpackage/resources/__UNI__XXXXXX/* android-project/app/src/main/assets/apps/

# 使用Android Studio构建
cd android-project
./gradlew assembleDebug

# APK位置: app/build/outputs/apk/debug/app-debug.apk
```

### iOS测试部署（TestFlight）

**1. 准备证书**
- Apple Developer账号
- iOS Distribution证书
- Provisioning Profile

**2. 使用HBuilderX云打包**
1. 发行 → 原生App-云打包
2. 选择iOS
3. 上传证书和描述文件
4. 打包

**3. 上传到TestFlight**
```bash
# 使用Xcode上传
xcrun altool --upload-app \
  --type ios \
  --file mota-app.ipa \
  --username your@email.com \
  --password app-specific-password
```

---

## 生产环境部署

### 环境变量配置

**生产环境配置** (`.env.production`):
```bash
# API地址
VITE_API_BASE_URL=https://api.mota.com

# 应用信息
VITE_APP_TITLE=摩塔

# 功能开关
VITE_ENABLE_MOCK=false
VITE_ENABLE_DEBUG=false

# 分析工具
VITE_ANALYTICS_ID=UA-XXXXXXXXX-X
```

### H5生产部署

**1. 构建优化**
```bash
# 构建生产版本
npm run build:h5

# 检查构建产物
ls -lh dist/build/h5/
```

**2. CDN部署**

上传到CDN（阿里云OSS示例）:
```bash
# 安装ossutil
wget http://gosspublic.alicdn.com/ossutil/1.7.15/ossutil64
chmod +x ossutil64

# 配置
./ossutil64 config

# 上传
./ossutil64 cp -r dist/build/h5/ oss://mota-app-prod/
```

**3. Nginx配置**
```nginx
server {
    listen 443 ssl http2;
    server_name app.mota.com;
    
    ssl_certificate /etc/nginx/ssl/mota.com.crt;
    ssl_certificate_key /etc/nginx/ssl/mota.com.key;
    
    root /var/www/mota-app/dist/build/h5;
    index index.html;
    
    # Gzip压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript;
    
    # 缓存策略
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    location / {
        try_files $uri $uri/ /index.html;
        add_header Cache-Control "no-cache";
    }
    
    # API代理
    location /api/ {
        proxy_pass https://api.mota.com;
        proxy_ssl_server_name on;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### Android生产部署

**1. 准备签名证书**

生成密钥库:
```bash
keytool -genkey -v \
  -keystore mota-release.keystore \
  -alias mota \
  -keyalg RSA \
  -keysize 2048 \
  -validity 10000
```

**2. 配置manifest.json**
```json
{
  "name": "摩塔",
  "appid": "__UNI__XXXXXX",
  "versionName": "1.0.0",
  "versionCode": "1",
  "android": {
    "permissions": [
      "android.permission.INTERNET",
      "android.permission.CAMERA",
      "android.permission.READ_EXTERNAL_STORAGE",
      "android.permission.WRITE_EXTERNAL_STORAGE"
    ]
  }
}
```

**3. 云打包**
1. 发行 → 原生App-云打包
2. 选择Android
3. 使用自有证书
4. 上传 `mota-release.keystore`
5. 输入证书密码和别名
6. 打包

**4. 加固（可选但推荐）**

使用360加固保:
1. 访问 https://jiagu.360.cn
2. 上传APK
3. 选择加固选项
4. 下载加固后的APK

### iOS生产部署

**1. 配置App Store信息**

在 `manifest.json` 中:
```json
{
  "name": "摩塔",
  "appid": "__UNI__XXXXXX",
  "versionName": "1.0.0",
  "versionCode": "1",
  "ios": {
    "dSYMs": false,
    "privacyDescription": {
      "NSCameraUsageDescription": "用于扫描二维码和拍照上传",
      "NSPhotoLibraryUsageDescription": "用于选择照片上传",
      "NSLocationWhenInUseUsageDescription": "用于获取位置信息"
    }
  }
}
```

**2. 云打包**
1. 发行 → 原生App-云打包
2. 选择iOS
3. 使用自有证书
4. 上传证书和描述文件
5. 打包

**3. 上传App Store**
```bash
# 验证IPA
xcrun altool --validate-app \
  --type ios \
  --file mota-app.ipa \
  --username your@email.com \
  --password app-specific-password

# 上传
xcrun altool --upload-app \
  --type ios \
  --file mota-app.ipa \
  --username your@email.com \
  --password app-specific-password
```

---

## 应用商店发布

### 应用宝（Android - 腾讯）

**发布流程**:
1. 访问 https://open.tencent.com
2. 创建应用 → 提交APK
3. 填写应用信息:
   - 应用名称: 摩塔
   - 应用简介: 企业AI项目管理平台
   - 应用类型: 办公商务
   - 版本号: 1.0.0
4. 上传截图（至少3张）
5. 上传图标（512x512 PNG）
6. 提交审核

**审核时间**: 1-3个工作日

### 华为应用市场（Android）

**发布流程**:
1. 访问 https://developer.huawei.com
2. 应用服务 → AppGallery Connect
3. 创建应用 → 上传APK
4. 配置应用信息
5. 隐私政策（必须）
6. 提交审核

### 小米应用商店（Android）

**发布流程**:
1. 访问 https://dev.mi.com/console
2. 应用管理 → 创建应用
3. 上传APK和资源
4. 软著登记号（可选但推荐）
5. 提交审核

### App Store（iOS - Apple）

**发布流程**:
1. 访问 https://appstoreconnect.apple.com
2. 我的App → 新建App
3. 配置App信息:
   - 名称: 摩塔
   - 副标题: AI项目管理
   - 类别: 商务
   - 年龄分级: 4+
4. 上传截图（多种设备尺寸）
5. 填写描述和关键词
6. 隐私政策URL（必须）
7. 提交审核

**审核时间**: 1-7天

**注意事项**:
- 必须提供测试账号
- 必须有隐私政策链接
- 截图必须包含实际应用内容
- 不能包含Beta/Test等字样

---

## 持续集成/持续部署（CI/CD）

### GitHub Actions示例

创建 `.github/workflows/deploy.yml`:
```yaml
name: Deploy Mobile App

on:
  push:
    tags:
      - 'v*'

jobs:
  build-h5:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'
      
      - name: Install dependencies
        run: npm install
        working-directory: mota-app
      
      - name: Build H5
        run: npm run build:h5
        working-directory: mota-app
      
      - name: Deploy to CDN
        run: |
          # 上传到OSS/CDN
          npm run deploy:h5
        env:
          OSS_ACCESS_KEY: ${{ secrets.OSS_ACCESS_KEY }}
          OSS_SECRET_KEY: ${{ secrets.OSS_SECRET_KEY }}
  
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup JDK
        uses: actions/setup-java@v3
        with:
          java-version: '11'
      
      - name: Build Android APK
        run: ./gradlew assembleRelease
        working-directory: android-project
      
      - name: Upload APK
        uses: actions/upload-artifact@v3
        with:
          name: app-release.apk
          path: android-project/app/build/outputs/apk/release/
```

---

## 版本管理

### 语义化版本

遵循 SemVer 规范:
- **主版本号**: 不兼容的API修改
- **次版本号**: 向下兼容的功能性新增
- **修订号**: 向下兼容的问题修正

示例:
- 1.0.0 - 初始版本
- 1.1.0 - 新增AI助手功能
- 1.1.1 - 修复登录bug

### 更新manifest.json

```json
{
  "versionName": "1.1.0",
  "versionCode": "110"
}
```

**注意**: `versionCode` 必须递增，用于应用商店判断新旧版本。

---

## 性能优化

### 1. 代码分割
```typescript
// 路由懒加载
const ProjectDetail = () => import('@/pages/project/detail/index.vue')
```

### 2. 图片优化
```bash
# 压缩图片
npm install -g imagemin-cli
imagemin src/static/images/* --out-dir=dist/images
```

### 3. 打包优化
```typescript
// vite.config.ts
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'vendor': ['vue', 'pinia'],
          'utils': ['@/utils/*']
        }
      }
    }
  }
})
```

---

## 监控和分析

### 1. 错误监控（Sentry）

```typescript
// main.ts
import * as Sentry from '@sentry/vue'

Sentry.init({
  dsn: 'https://xxxxx@sentry.io/xxxxx',
  environment: import.meta.env.MODE
})
```

### 2. 统计分析（友盟）

```typescript
// manifest.json
{
  "plus": {
    "distribute": {
      "plugins": {
        "umeng": {
          "appkey_android": "your-android-key",
          "appkey_ios": "your-ios-key"
        }
      }
    }
  }
}
```

---

## 常见问题

### Q1: H5部署后白屏？

**检查**:
1. 路径配置: `vite.config.ts` 中的 `base`
2. 路由模式: 使用 `hash` 模式而非 `history`
3. 浏览器兼容性: 检查目标浏览器版本

**解决**:
```typescript
// vite.config.ts
export default defineConfig({
  base: '/mota-app/'  // 子路径部署
})
```

### Q2: Android打包后无法请求API？

**检查**:
1. `manifest.json` 中是否允许HTTP请求
2. 是否添加网络权限

**解决**:
```json
{
  "android": {
    "permissions": [
      "android.permission.INTERNET"
    ],
    "usesCleartextTraffic": true
  }
}
```

### Q3: iOS上传失败？

**常见原因**:
- 证书过期
- BundleID不匹配
- 版本号重复

**解决**:
1. 检查证书有效期
2. 确认BundleID与证书一致
3. 递增versionCode

### Q4: 应用商店审核被拒？

**常见原因**:
- 缺少隐私政策
- 功能描述不清
- 截图不符合要求
- 测试账号无效

**解决**:
1. 添加隐私政策页面
2. 详细描述应用功能
3. 提供多张清晰截图
4. 确保测试账号可用

---

## 检查清单

### 发布前检查

- [ ] 版本号已更新
- [ ] API地址配置正确
- [ ] 所有功能测试通过
- [ ] 性能测试达标
- [ ] 安全扫描无高危漏洞
- [ ] 隐私政策已添加
- [ ] 用户协议已添加
- [ ] 截图已准备（各尺寸）
- [ ] 图标已准备（各尺寸）
- [ ] 更新日志已编写

### Android额外检查

- [ ] 签名证书已配置
- [ ] 混淆规则已配置
- [ ] 权限声明合理
- [ ] 多渠道包已准备

### iOS额外检查

- [ ] 证书和描述文件有效
- [ ] 隐私权限描述完整
- [ ] 支持的设备类型已选择
- [ ] 测试账号已准备

---

## 总结

本文档涵盖了 mota-app 移动端应用从开发到生产的完整部署流程。

**快速链接**:
- [H5开发](#1-h5开发模式web浏览器)
- [Android开发](#2-android开发模式)
- [后端启动](./07-后端服务启动指南.md)
- [HBuilderX指南](./06-HBuilderX启动Android项目指南.md)

**支持**:
- 技术问题: 查看项目README
- 部署问题: 本文档
- 后端问题: 查看mota-service文档