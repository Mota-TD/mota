# mota-app 项目启动问题修复总结

## 问题描述

用户尝试启动 mota-app 项目时遇到错误：
```
Error: Cannot find module '../../../uni-cli-shared/dist'
```

## 问题诊断

### 根本原因
1. **依赖版本问题**：初始项目使用的 uni-app 包版本为 `3.0.0-4020920240930001` (alpha版本)，这些版本存在以下问题：
   - 包结构不完整（缺少 `lib` 目录）
   - 内部依赖路径解析问题
   - pnpm 的依赖提升策略不兼容

2. **包管理器兼容性**：pnpm 的严格依赖隔离机制与 uni-app 的相对路径引用不兼容

### 诊断过程

1. **第一次尝试**：配置 pnpm 的 `.npmrc` 文件
   ```
   shamefully-hoist=true
   public-hoist-pattern[]=@dcloudio/*
   ```
   结果：失败，pnpm 未在 `.pnpm` 内部创建必要的符号链接

2. **第二次尝试**：切换到 npm + `--legacy-peer-deps`
   结果：安装成功但遇到新错误：缺少 SSR 入口文件

3. **最终解决方案**：升级到最新稳定版本

## 解决方案

### 步骤1：更新依赖版本
将 [`package.json`](package.json:1) 中的所有 `@dcloudio` 包升级到最新版本：

```json
{
  "dependencies": {
    "@dcloudio/uni-app": "3.0.0-4080420251103001",
    "@dcloudio/uni-app-plus": "3.0.0-4080420251103001",
    "@dcloudio/uni-components": "3.0.0-4080420251103001",
    "@dcloudio/uni-h5": "3.0.0-4080420251103001",
    "@dcloudio/uni-mp-alipay": "3.0.0-4080420251103001",
    "@dcloudio/uni-mp-weixin": "3.0.0-4080420251103001"
  },
  "devDependencies": {
    "@dcloudio/types": "^3.4.8",
    "@dcloudio/uni-automator": "3.0.0-4080420251103001",
    "@dcloudio/uni-cli-shared": "3.0.0-4080420251103001",
    "@dcloudio/uni-stacktracey": "3.0.0-4080420251103001",
    "@dcloudio/vite-plugin-uni": "3.0.0-4080420251103001",
    "vite": "5.2.8",
    "typescript": "^4.9.4",
    "vue-tsc": "^1.0.24"
  }
}
```

### 步骤2：清理并重新安装
```bash
cd mota-app
rmdir /s /q node_modules
del package-lock.json
npm install --legacy-peer-deps
```

### 步骤3：启动项目
```bash
npm run dev:h5
```

## 启动成功

项目成功启动在：
- **本地地址**：http://localhost:3000/
- **网络地址**：http://10.0.0.39:3000/
- **启动时间**：1518ms

```
vite v5.2.8 dev server running at:

➜  Local:   http://localhost:3000/
➜  Network: http://10.0.0.39:3000/
➜  Network: http://172.29.48.1:3000/

ready in 1518ms.
```

## 技术要点

### 1. uni-app 版本选择
- ❌ 避免使用 alpha 早期版本（如 4020920240930001）
- ✅ 使用最新稳定版本（如 4080420251103001）
- 参考官方模板：`dcloudio/uni-preset-vue#vite-ts`

### 2. 包管理器选择
- **pnpm**：严格依赖隔离，与某些 uni-app 版本不兼容
- **npm**：使用 `--legacy-peer-deps` 可解决大部分依赖冲突
- 推荐：npm（兼容性更好）

### 3. 依赖安装参数
```bash
npm install --legacy-peer-deps
```
该参数允许安装时忽略 peer dependencies 冲突，适用于 uni-app 等复杂依赖结构

## 关键文件变更

### [`package.json`](package.json:1)
- 所有 `@dcloudio` 包版本升级
- Vite 版本降级到 `5.2.8`（与 uni-app 兼容）
- TypeScript 版本调整到 `^4.9.4`
- vue-tsc 版本调整到 `^1.0.24`

### 包管理
- 移除了 `.npmrc`（pnpm 配置）
- 删除了 `pnpm-lock.yaml`
- 使用 npm 的 `package-lock.json`

## 经验总结

1. **优先使用官方模板**：遇到框架项目问题时，参考官方模板的依赖版本
2. **版本兼容性**：uni-app 对依赖版本要求严格，需使用推荐版本
3. **包管理器选择**：根据项目特性选择合适的包管理器
4. **问题排查**：
   - 检查包结构完整性
   - 验证依赖路径解析
   - 对比官方模板配置

## 下一步工作

项目现已成功启动，可以继续进行：
1. 在浏览器中访问 http://localhost:3000/ 查看运行效果
2. 测试所有已开发的功能模块
3. 进行跨平台构建测试
4. 准备生产环境部署

---

**修复日期**：2026-01-30  
**修复人员**：Tron Code  
**用时**：约30分钟  
**最终状态**：✅ 成功启动